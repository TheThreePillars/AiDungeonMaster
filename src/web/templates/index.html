<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Dungeon Master - Pathfinder 1e</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-surface: #161b22;
            --bg-elevated: #21262d;
            --bg-hover: #30363d;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-gold: #d4a017;
            --accent-purple: #8b5cf6;
            --accent-blue: #58a6ff;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --hp-high: #3fb950;
            --hp-mid: #d29922;
            --hp-low: #f85149;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        /* ===== TITLE SCREEN ===== */
        #title-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            background: linear-gradient(180deg, var(--bg-dark) 0%, #1a1a2e 100%);
        }

        .title-card {
            background: var(--bg-surface);
            border: 2px solid var(--accent-gold);
            border-radius: 1rem;
            padding: 2.5rem;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 0 40px rgba(212, 160, 23, 0.2);
        }

        .game-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .game-title {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px rgba(212, 160, 23, 0.5);
        }

        .game-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .menu-btn {
            display: block;
            width: 100%;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .menu-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-gold);
        }

        .menu-btn.primary {
            background: linear-gradient(135deg, #2d5a27 0%, #1e3a1a 100%);
            border-color: var(--success);
        }

        .menu-btn.primary:hover {
            background: linear-gradient(135deg, #3d7a37 0%, #2e5a2a 100%);
        }

        .menu-divider {
            height: 1px;
            background: var(--border);
            margin: 1rem 0;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.offline {
            background: var(--danger);
        }

        /* ===== NAME INPUT MODAL ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 360px;
            width: 100%;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* ===== GAME SCREEN ===== */
        #game-screen {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .game-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
        }

        .location-info {
            flex: 1;
        }

        .location-name {
            font-weight: 600;
            color: var(--accent-gold);
            font-size: 1rem;
        }

        .location-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .header-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Main Layout */
        .game-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 100;
                width: 85%;
                max-width: 320px;
            }

            .sidebar.visible {
                display: flex;
            }
        }

        .sidebar-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        /* Party Members */
        .party-member {
            background: var(--bg-elevated);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .member-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .member-class {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .hp-bar-container {
            background: var(--bg-dark);
            border-radius: 0.25rem;
            height: 8px;
            overflow: hidden;
        }

        .hp-bar {
            height: 100%;
            background: var(--hp-high);
            transition: width 0.3s, background 0.3s;
        }

        .hp-bar.mid { background: var(--hp-mid); }
        .hp-bar.low { background: var(--hp-low); }

        .hp-text {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-purple);
        }

        .action-btn.combat {
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Narrative Area */
        .narrative-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .narrative-log {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg-dark);
        }

        .narrative-entry {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .entry-dm {
            padding: 1rem;
            background: var(--bg-surface);
            border-left: 3px solid var(--accent-purple);
            border-radius: 0 0.5rem 0.5rem 0;
        }

        .entry-player {
            padding: 0.75rem 1rem;
            background: var(--bg-elevated);
            border-left: 3px solid var(--accent-blue);
            border-radius: 0 0.5rem 0.5rem 0;
        }

        .entry-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .entry-dm .entry-header {
            color: var(--accent-purple);
        }

        .entry-player .entry-header {
            color: var(--accent-blue);
        }

        .entry-system {
            text-align: center;
            padding: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .entry-dice {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--accent-gold);
            border-radius: 2rem;
            font-size: 0.875rem;
        }

        .dice-result {
            font-weight: bold;
            color: var(--accent-gold);
        }

        .typing-indicator {
            display: none;
            padding: 1rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .typing-indicator.visible {
            display: block;
        }

        /* Input Area */
        .input-area {
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
            padding: 0.75rem 1rem;
        }

        .input-row {
            display: flex;
            gap: 0.5rem;
        }

        .action-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
        }

        .action-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .input-btn {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 1.25rem;
            cursor: pointer;
            min-width: 48px;
        }

        .input-btn:hover {
            background: var(--bg-hover);
        }

        .input-btn.recording {
            background: var(--danger);
            border-color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Bottom Quick Bar */
        .quick-bar {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
            overflow-x: auto;
        }

        .quick-chip {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 2rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.875rem;
            white-space: nowrap;
            cursor: pointer;
        }

        .quick-chip:hover {
            border-color: var(--accent-gold);
        }

        /* Dice Panel */
        .dice-panel {
            display: none;
            padding: 1rem;
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
        }

        .dice-panel.visible {
            display: block;
        }

        .dice-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
        }

        @media (max-width: 480px) {
            .dice-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .dice-btn {
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .dice-btn:hover {
            border-color: var(--accent-gold);
            background: rgba(212, 160, 23, 0.1);
        }

        /* Right Panel - NPCs */
        .right-panel {
            width: 240px;
            background: var(--bg-surface);
            border-left: 1px solid var(--border);
            padding: 1rem;
            overflow-y: auto;
        }

        @media (max-width: 1024px) {
            .right-panel {
                display: none;
            }
        }

        .npc-item {
            background: var(--bg-elevated);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .npc-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .npc-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Players list */
        .players-list {
            padding: 0;
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-elevated);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .player-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .player-name {
            font-size: 0.875rem;
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .sidebar-overlay.visible {
            display: block;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Title Screen -->
    <div id="title-screen">
        <div class="title-card">
            <div class="game-icon">&#x1F3B2;</div>
            <h1 class="game-title">AI Dungeon Master</h1>
            <p class="game-subtitle">Pathfinder 1st Edition</p>

            <button class="menu-btn primary" id="btn-new-game">&#x25B6; New Game</button>
            <button class="menu-btn" id="btn-continue">&#x1F4BE; Continue Game</button>

            <div class="menu-divider"></div>

            <button class="menu-btn" id="btn-characters">&#x1F9D9; Manage Characters</button>
            <button class="menu-btn" id="btn-bestiary">&#x1F432; Bestiary</button>
            <button class="menu-btn" id="btn-settings">&#x2699; Settings</button>

            <div class="status-bar">
                <div class="status-item">
                    <span class="status-dot" id="ai-status-dot"></span>
                    <span id="ai-status-text">Checking AI...</span>
                </div>
                <div class="status-item">
                    <span id="version-text">v0.2.0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Name Input Modal -->
    <div class="modal-overlay" id="name-modal">
        <div class="modal-card">
            <h2 class="modal-title">Enter Your Name</h2>
            <div class="form-group">
                <label class="form-label" for="player-name">Character Name</label>
                <input type="text" id="player-name" class="form-input" placeholder="Valeros the Brave" autocomplete="off">
            </div>
            <button class="menu-btn primary" id="btn-join">Begin Adventure</button>
            <button class="menu-btn" id="btn-cancel">Cancel</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen">
        <!-- Header -->
        <header class="game-header">
            <button class="header-btn" id="btn-menu">&#x2630;</button>
            <div class="location-info">
                <div class="location-name" id="location-name">The Rusty Dragon Inn</div>
                <div class="location-time" id="location-time">Evening</div>
            </div>
            <div class="header-status">
                <span class="status-dot" id="game-status-dot"></span>
                <span id="game-status-text">AI Online</span>
            </div>
            <button class="header-btn" id="btn-players">&#x1F465;</button>
        </header>

        <!-- Main Content -->
        <div class="game-main">
            <!-- Left Sidebar -->
            <aside class="sidebar" id="sidebar">
                <!-- Party Section -->
                <div class="sidebar-section">
                    <div class="section-title">&#x2694; Party</div>
                    <div id="party-list">
                        <div class="party-member">
                            <div class="member-header">
                                <span class="member-name">No Characters</span>
                            </div>
                            <div class="member-class">Create a character to begin</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="sidebar-section">
                    <div class="section-title">&#x26A1; Quick Actions</div>
                    <div class="quick-actions">
                        <button class="action-btn" data-action="I look around carefully, examining my surroundings.">&#x1F441; Look Around</button>
                        <button class="action-btn" data-action="I take a short rest to recover.">&#x1F4A4; Rest</button>
                        <button class="action-btn" data-action="I check my inventory and equipment.">&#x1F392; Inventory</button>
                        <button class="action-btn" data-action="I search the area for hidden items or secrets.">&#x1F50D; Search</button>
                        <button class="action-btn combat" data-action="I draw my weapon and prepare for combat!">&#x2694; Combat</button>
                    </div>
                </div>

                <!-- Players Online -->
                <div class="sidebar-section">
                    <div class="section-title">&#x1F465; Players Online</div>
                    <div class="players-list" id="players-list">
                        <div class="player-item">
                            <span style="color: var(--text-muted); font-size: 0.875rem;">No players connected</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Sidebar Overlay (mobile) -->
            <div class="sidebar-overlay" id="sidebar-overlay"></div>

            <!-- Narrative Area -->
            <main class="narrative-area">
                <div class="narrative-log" id="narrative-log">
                    <div class="narrative-entry entry-dm">
                        <div class="entry-header">&#x1F3AD; Dungeon Master</div>
                        <div class="entry-content">
                            <strong>Welcome, adventurer!</strong><br><br>
                            You find yourself in the common room of the Rusty Dragon Inn. The smell of roasting meat and fresh bread fills the air. Patrons laugh and chat at nearby tables while a bard strums a lute in the corner.<br><br>
                            <em>What would you like to do?</em>
                        </div>
                    </div>
                    <div class="typing-indicator" id="typing-indicator">
                        &#x1F3AD; The Dungeon Master is thinking...
                    </div>
                </div>

                <!-- Dice Panel -->
                <div class="dice-panel" id="dice-panel">
                    <div class="dice-grid">
                        <button class="dice-btn" data-dice="1d4">d4</button>
                        <button class="dice-btn" data-dice="1d6">d6</button>
                        <button class="dice-btn" data-dice="1d8">d8</button>
                        <button class="dice-btn" data-dice="1d10">d10</button>
                        <button class="dice-btn" data-dice="1d12">d12</button>
                        <button class="dice-btn" data-dice="1d20">d20</button>
                    </div>
                </div>

                <!-- Quick Bar -->
                <div class="quick-bar">
                    <button class="quick-chip" id="btn-dice-toggle">&#x1F3B2; Roll Dice</button>
                    <button class="quick-chip" data-action="I talk to the bartender.">&#x1F5E3; Talk</button>
                    <button class="quick-chip" data-action="I order a drink.">&#x1F37A; Drink</button>
                    <button class="quick-chip" data-action="I listen for rumors.">&#x1F442; Listen</button>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-row">
                        <textarea class="action-input" id="action-input" rows="1" placeholder="What do you do?"></textarea>
                        <button class="input-btn" id="voice-btn" title="Hold to speak">&#x1F3A4;</button>
                        <button class="input-btn" id="send-btn">&#x27A4;</button>
                    </div>
                </div>
            </main>

            <!-- Right Panel - NPCs -->
            <aside class="right-panel">
                <div class="section-title">&#x1F9D1; NPCs Nearby</div>
                <div id="npc-list">
                    <div class="npc-item">
                        <div class="npc-name">Ameiko Kaijitsu</div>
                        <div class="npc-desc">Innkeeper, standing behind the bar</div>
                    </div>
                    <div class="npc-item">
                        <div class="npc-name">Traveling Merchant</div>
                        <div class="npc-desc">Sitting alone, counting coins</div>
                    </div>
                    <div class="npc-item">
                        <div class="npc-name">Local Bard</div>
                        <div class="npc-desc">Playing a lute in the corner</div>
                    </div>
                </div>

                <div class="section-title" style="margin-top: 1.5rem;">&#x1F4DC; Active Quests</div>
                <div id="quest-list">
                    <div class="npc-item">
                        <div class="npc-name">A New Beginning</div>
                        <div class="npc-desc">Find adventure in Sandpoint</div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // State
        const state = {
            playerName: '',
            ws: null,
            connected: false,
            recording: false,
            mediaRecorder: null,
            audioChunks: [],
            aiAvailable: false,
            speechAvailable: false,
        };

        // Elements
        const titleScreen = document.getElementById('title-screen');
        const gameScreen = document.getElementById('game-screen');
        const nameModal = document.getElementById('name-modal');
        const playerNameInput = document.getElementById('player-name');
        const narrativeLog = document.getElementById('narrative-log');
        const actionInput = document.getElementById('action-input');
        const typingIndicator = document.getElementById('typing-indicator');
        const dicePanel = document.getElementById('dice-panel');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        // Check server status
        async function checkStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                state.aiAvailable = data.ai_available;
                state.speechAvailable = data.speech_available;

                // Update title screen status
                const dot = document.getElementById('ai-status-dot');
                const text = document.getElementById('ai-status-text');
                dot.classList.toggle('offline', !data.ai_available);
                text.textContent = data.ai_available ? 'AI Online' : 'AI Offline';

                // Update game screen status
                const gameDot = document.getElementById('game-status-dot');
                const gameText = document.getElementById('game-status-text');
                if (gameDot) {
                    gameDot.classList.toggle('offline', !data.ai_available);
                    gameText.textContent = data.ai_available ? 'AI Online' : 'AI Offline';
                }

                // Voice button
                const voiceBtn = document.getElementById('voice-btn');
                voiceBtn.style.opacity = data.speech_available ? '1' : '0.5';
                voiceBtn.title = data.speech_available ? 'Hold to speak' : 'Voice unavailable';
            } catch (e) {
                document.getElementById('ai-status-dot').classList.add('offline');
                document.getElementById('ai-status-text').textContent = 'Server Offline';
            }
        }

        // Connect WebSocket
        function connect() {
            const wsUrl = `ws://${window.location.host}/ws/${state.playerName}`;
            state.ws = new WebSocket(wsUrl);

            state.ws.onopen = () => {
                state.connected = true;
                console.log('Connected to server');
            };

            state.ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };

            state.ws.onclose = () => {
                state.connected = false;
                console.log('Disconnected');
                setTimeout(connect, 3000);
            };

            state.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Handle incoming messages
        function handleMessage(data) {
            switch (data.type) {
                case 'connected':
                    document.getElementById('location-name').textContent = data.location || 'Unknown Location';
                    break;

                case 'player_joined':
                    addSystemEntry(`${data.player_name} joined the adventure`);
                    updatePlayersList(data.players || []);
                    break;

                case 'player_left':
                    addSystemEntry(`${data.player_name} left the game`);
                    updatePlayersList(data.players || []);
                    break;

                case 'player_action':
                    if (data.player !== state.playerName) {
                        addPlayerEntry(data.player, data.action);
                    }
                    break;

                case 'dm_typing':
                    typingIndicator.classList.toggle('visible', data.status);
                    scrollToBottom();
                    break;

                case 'dm_response_stream':
                    updateStreamingEntry(data.token);
                    break;

                case 'dm_response':
                    typingIndicator.classList.remove('visible');
                    finalizeStreamingEntry(data.content);
                    break;

                case 'dice_roll':
                    addDiceEntry(data.player, data.notation, data.result, data.rolls);
                    break;

                case 'chat':
                    addPlayerEntry(data.player, data.content);
                    break;

                case 'error':
                    addSystemEntry(`Error: ${data.message}`);
                    break;
            }
        }

        // Narrative entries
        let streamingEntry = null;

        function addDMEntry(content) {
            const entry = document.createElement('div');
            entry.className = 'narrative-entry entry-dm';
            entry.innerHTML = `
                <div class="entry-header">&#x1F3AD; Dungeon Master</div>
                <div class="entry-content">${escapeHtml(content)}</div>
            `;
            narrativeLog.insertBefore(entry, typingIndicator);
            scrollToBottom();
        }

        function addPlayerEntry(player, content) {
            const entry = document.createElement('div');
            entry.className = 'narrative-entry entry-player';
            entry.innerHTML = `
                <div class="entry-header">&#x2694; ${escapeHtml(player)}</div>
                <div class="entry-content">${escapeHtml(content)}</div>
            `;
            narrativeLog.insertBefore(entry, typingIndicator);
            scrollToBottom();
        }

        function addSystemEntry(content) {
            const entry = document.createElement('div');
            entry.className = 'narrative-entry entry-system';
            entry.textContent = content;
            narrativeLog.insertBefore(entry, typingIndicator);
            scrollToBottom();
        }

        function addDiceEntry(player, notation, result, rolls) {
            const entry = document.createElement('div');
            entry.className = 'narrative-entry';
            entry.innerHTML = `
                <div class="entry-dice">
                    &#x1F3B2; ${escapeHtml(player)} rolled ${notation}:
                    <span class="dice-result">${result}</span>
                    <span style="color: var(--text-muted);">[${rolls.join(', ')}]</span>
                </div>
            `;
            narrativeLog.insertBefore(entry, typingIndicator);
            scrollToBottom();
        }

        function updateStreamingEntry(token) {
            if (!streamingEntry) {
                streamingEntry = document.createElement('div');
                streamingEntry.className = 'narrative-entry entry-dm';
                streamingEntry.innerHTML = `
                    <div class="entry-header">&#x1F3AD; Dungeon Master</div>
                    <div class="entry-content"></div>
                `;
                narrativeLog.insertBefore(streamingEntry, typingIndicator);
            }
            const content = streamingEntry.querySelector('.entry-content');
            content.textContent += token;
            scrollToBottom();
        }

        function finalizeStreamingEntry(fullContent) {
            if (streamingEntry) {
                const content = streamingEntry.querySelector('.entry-content');
                content.textContent = fullContent;
                streamingEntry = null;
            } else {
                addDMEntry(fullContent);
            }
            scrollToBottom();
        }

        function scrollToBottom() {
            narrativeLog.scrollTop = narrativeLog.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updatePlayersList(players) {
            const list = document.getElementById('players-list');
            if (players.length === 0) {
                list.innerHTML = '<div class="player-item"><span style="color: var(--text-muted); font-size: 0.875rem;">No players connected</span></div>';
            } else {
                list.innerHTML = players.map(name => `
                    <div class="player-item">
                        <div class="player-avatar">${name.charAt(0).toUpperCase()}</div>
                        <span class="player-name">${escapeHtml(name)}</span>
                    </div>
                `).join('');
            }
        }

        // Send action
        function sendAction() {
            const action = actionInput.value.trim();
            if (!action || !state.connected) return;

            addPlayerEntry(state.playerName, action);
            state.ws.send(JSON.stringify({
                type: 'player_action',
                action: action,
            }));

            actionInput.value = '';
            actionInput.style.height = 'auto';
        }

        // Roll dice
        function rollDice(notation) {
            if (!state.connected) return;
            state.ws.send(JSON.stringify({
                type: 'dice_roll',
                notation: notation,
            }));
            dicePanel.classList.remove('visible');
        }

        // Voice recording
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];

                state.mediaRecorder.ondataavailable = (e) => {
                    state.audioChunks.push(e.data);
                };

                state.mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                    stream.getTracks().forEach(track => track.stop());

                    addSystemEntry('Transcribing voice...');
                    try {
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'voice.webm');

                        const res = await fetch('/api/transcribe', {
                            method: 'POST',
                            body: formData,
                        });

                        if (res.ok) {
                            const data = await res.json();
                            if (data.text && data.text.trim()) {
                                actionInput.value = data.text.trim();
                                sendAction();
                            } else {
                                addSystemEntry('No speech detected');
                            }
                        } else if (res.status === 503) {
                            addSystemEntry('Voice not available');
                        } else {
                            addSystemEntry('Transcription failed');
                        }
                    } catch (e) {
                        console.error('Transcription error:', e);
                        addSystemEntry('Transcription error');
                    }
                };

                state.mediaRecorder.start();
                state.recording = true;
                document.getElementById('voice-btn').classList.add('recording');
            } catch (e) {
                console.error('Recording error:', e);
                addSystemEntry('Microphone access denied');
            }
        }

        function stopRecording() {
            if (state.mediaRecorder && state.recording) {
                state.mediaRecorder.stop();
                state.recording = false;
                document.getElementById('voice-btn').classList.remove('recording');
            }
        }

        // Start game
        function startGame() {
            const name = playerNameInput.value.trim();
            if (!name) {
                playerNameInput.focus();
                return;
            }
            state.playerName = name;
            nameModal.classList.remove('visible');
            titleScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
            connect();
        }

        // Event Listeners
        document.getElementById('btn-new-game').addEventListener('click', () => {
            nameModal.classList.add('visible');
            playerNameInput.focus();
        });

        document.getElementById('btn-join').addEventListener('click', startGame);
        document.getElementById('btn-cancel').addEventListener('click', () => {
            nameModal.classList.remove('visible');
        });

        playerNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startGame();
        });

        document.getElementById('send-btn').addEventListener('click', sendAction);
        actionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAction();
            }
        });

        actionInput.addEventListener('input', () => {
            actionInput.style.height = 'auto';
            actionInput.style.height = Math.min(actionInput.scrollHeight, 120) + 'px';
        });

        // Voice button
        const voiceBtn = document.getElementById('voice-btn');
        voiceBtn.addEventListener('mousedown', startRecording);
        voiceBtn.addEventListener('mouseup', stopRecording);
        voiceBtn.addEventListener('mouseleave', stopRecording);
        voiceBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRecording(); });
        voiceBtn.addEventListener('touchend', stopRecording);

        // Dice toggle
        document.getElementById('btn-dice-toggle').addEventListener('click', () => {
            dicePanel.classList.toggle('visible');
        });

        // Dice buttons
        document.querySelectorAll('.dice-btn').forEach(btn => {
            btn.addEventListener('click', () => rollDice(btn.dataset.dice));
        });

        // Quick actions and chips
        document.querySelectorAll('.action-btn, .quick-chip[data-action]').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.dataset.action && state.connected) {
                    actionInput.value = btn.dataset.action;
                    sendAction();
                    sidebar.classList.remove('visible');
                    sidebarOverlay.classList.remove('visible');
                }
            });
        });

        // Mobile sidebar toggle
        document.getElementById('btn-menu').addEventListener('click', () => {
            sidebar.classList.add('visible');
            sidebarOverlay.classList.add('visible');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('visible');
            sidebarOverlay.classList.remove('visible');
        });

        // Initialize
        checkStatus();
        setInterval(checkStatus, 30000);
    </script>
</body>
</html>
