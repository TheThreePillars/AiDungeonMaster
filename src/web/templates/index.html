<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Dungeon Master - Pathfinder 1e</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-surface: #161b22;
            --bg-elevated: #21262d;
            --bg-hover: #30363d;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-gold: #d4a017;
            --accent-purple: #8b5cf6;
            --accent-blue: #58a6ff;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --hp-high: #3fb950;
            --hp-mid: #d29922;
            --hp-low: #f85149;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport height for mobile */
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* ===== TITLE SCREEN ===== */
        #title-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            min-height: 100dvh;
            padding: 1rem;
            background: linear-gradient(180deg, var(--bg-dark) 0%, #1a1a2e 100%);
            overflow-y: auto;
        }

        .title-card {
            background: var(--bg-surface);
            border: 2px solid var(--accent-gold);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 0 40px rgba(212, 160, 23, 0.2);
        }

        @media (min-width: 480px) {
            #title-screen {
                padding: 2rem;
            }
            .title-card {
                padding: 2.5rem;
            }
        }

        .game-icon {
            font-size: 3rem;
            margin-bottom: 0.75rem;
        }

        @media (min-width: 480px) {
            .game-icon {
                font-size: 4rem;
                margin-bottom: 1rem;
            }
        }

        .game-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 0.25rem;
            text-shadow: 0 0 20px rgba(212, 160, 23, 0.5);
        }

        @media (min-width: 480px) {
            .game-title {
                font-size: 1.75rem;
                margin-bottom: 0.5rem;
            }
        }

        .game-subtitle {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }

        @media (min-width: 480px) {
            .game-subtitle {
                margin-bottom: 2rem;
                font-size: 1rem;
            }
        }

        .menu-btn {
            display: block;
            width: 100%;
            padding: 0.875rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            min-height: 44px; /* Touch-friendly target */
        }

        @media (min-width: 480px) {
            .menu-btn {
                padding: 1rem;
                margin-bottom: 0.75rem;
                font-size: 1rem;
            }
        }

        .menu-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-gold);
        }

        .menu-btn.primary {
            background: linear-gradient(135deg, #2d5a27 0%, #1e3a1a 100%);
            border-color: var(--success);
        }

        .menu-btn.primary:hover {
            background: linear-gradient(135deg, #3d7a37 0%, #2e5a2a 100%);
        }

        .menu-divider {
            height: 1px;
            background: var(--border);
            margin: 1rem 0;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.offline {
            background: var(--danger);
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: flex-start;
            justify-content: center;
            padding: 0.5rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (min-width: 480px) {
            .modal-overlay {
                align-items: center;
                padding: 1rem;
            }
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            max-width: 360px;
            width: 100%;
            margin: 0.5rem 0;
            max-height: calc(100vh - 1rem);
            max-height: calc(100dvh - 1rem);
            overflow-y: auto;
        }

        @media (min-width: 480px) {
            .modal-card {
                padding: 1.5rem;
                border-radius: 1rem;
                margin: 1rem 0;
                max-height: calc(100vh - 2rem);
                max-height: calc(100dvh - 2rem);
            }
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        @media (min-width: 480px) {
            .modal-title {
                font-size: 1.25rem;
                margin-bottom: 1.5rem;
            }
        }

        .form-group {
            margin-bottom: 1rem;
        }

        @media (min-width: 480px) {
            .form-group {
                margin-bottom: 1.5rem;
            }
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.375rem;
        }

        @media (min-width: 480px) {
            .form-label {
                font-size: 0.875rem;
                margin-bottom: 0.5rem;
            }
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 16px; /* Prevents iOS zoom */
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* ===== GAME SCREEN ===== */
        #game-screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }

        /* Header */
        .game-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        @media (min-width: 480px) {
            .game-header {
                padding: 0.75rem 1rem;
                gap: 0.75rem;
            }
        }

        .location-info {
            flex: 1;
            min-width: 0; /* Allow text truncation */
        }

        .location-name {
            font-weight: 600;
            color: var(--accent-gold);
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (min-width: 480px) {
            .location-name {
                font-size: 1rem;
            }
        }

        .location-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .header-status {
            display: none; /* Hidden on mobile */
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        @media (min-width: 480px) {
            .header-status {
                display: flex;
            }
        }

        .header-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            padding: 0.375rem 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            min-width: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 480px) {
            .header-btn {
                padding: 0.5rem 0.75rem;
                border-radius: 0.5rem;
            }
        }

        .header-char-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            border: none;
            border-radius: 1rem;
            padding: 0.25rem 0.75rem 0.25rem 0.375rem;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-char-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
        }

        .header-char-btn .char-avatar {
            font-size: 1.25rem;
        }

        .header-char-btn .char-name-display {
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (max-width: 480px) {
            .header-char-btn .char-name-display {
                display: none;
            }
        }

        /* Main Layout */
        .game-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 100;
                width: 85%;
                max-width: 320px;
            }

            .sidebar.visible {
                display: flex;
            }
        }

        .sidebar-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        /* Party Members */
        .party-member {
            background: var(--bg-elevated);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .member-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .member-class {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .hp-bar-container {
            background: var(--bg-dark);
            border-radius: 0.25rem;
            height: 8px;
            overflow: hidden;
        }

        .hp-bar {
            height: 100%;
            background: var(--hp-high);
            transition: width 0.3s, background 0.3s;
        }

        .hp-bar.mid { background: var(--hp-mid); }
        .hp-bar.low { background: var(--hp-low); }

        .hp-text {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-purple);
        }

        .action-btn.combat {
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Narrative Area */
        .narrative-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0; /* Important for flexbox overflow */
        }

        .narrative-log {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            background: var(--bg-dark);
            -webkit-overflow-scrolling: touch;
        }

        @media (min-width: 480px) {
            .narrative-log {
                padding: 1rem;
            }
        }

        .narrative-entry {
            margin-bottom: 0.75rem;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        @media (min-width: 480px) {
            .narrative-entry {
                margin-bottom: 1rem;
                line-height: 1.6;
                font-size: 1rem;
            }
        }

        .entry-dm {
            padding: 0.75rem;
            background: var(--bg-surface);
            border-left: 3px solid var(--accent-purple);
            border-radius: 0 0.5rem 0.5rem 0;
        }

        @media (min-width: 480px) {
            .entry-dm {
                padding: 1rem;
            }
        }

        .entry-player {
            padding: 0.625rem 0.75rem;
            background: var(--bg-elevated);
            border-left: 3px solid var(--accent-blue);
            border-radius: 0 0.5rem 0.5rem 0;
        }

        @media (min-width: 480px) {
            .entry-player {
                padding: 0.75rem 1rem;
            }
        }

        .entry-header {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.375rem;
        }

        @media (min-width: 480px) {
            .entry-header {
                font-size: 0.75rem;
                margin-bottom: 0.5rem;
            }
        }

        .entry-dm .entry-header {
            color: var(--accent-purple);
        }

        .entry-player .entry-header {
            color: var(--accent-blue);
        }

        .entry-system {
            text-align: center;
            padding: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .entry-dice {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--accent-gold);
            border-radius: 2rem;
            font-size: 0.875rem;
        }

        .dice-result {
            font-weight: bold;
            color: var(--accent-gold);
        }

        .typing-indicator {
            display: none;
            padding: 1rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .typing-indicator.visible {
            display: block;
        }

        /* Input Area */
        .input-area {
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
            padding: 0.5rem;
            flex-shrink: 0;
        }

        @media (min-width: 480px) {
            .input-area {
                padding: 0.75rem 1rem;
            }
        }

        .input-row {
            display: flex;
            gap: 0.375rem;
        }

        @media (min-width: 480px) {
            .input-row {
                gap: 0.5rem;
            }
        }

        .action-input {
            flex: 1;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 16px; /* Prevents iOS zoom */
            resize: none;
            min-height: 40px;
        }

        @media (min-width: 480px) {
            .action-input {
                padding: 0.75rem 1rem;
            }
        }

        .action-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .input-btn {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 1.125rem;
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        @media (min-width: 480px) {
            .input-btn {
                padding: 0.75rem;
                font-size: 1.25rem;
                min-width: 48px;
            }
        }

        .input-btn:hover {
            background: var(--bg-hover);
        }

        .input-btn.recording {
            background: var(--danger);
            border-color: var(--danger);
            animation: pulse 1s infinite;
        }

        .input-btn.listening {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            animation: pulse-listen 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes pulse-listen {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Bottom Quick Bar */
        .quick-bar {
            display: flex;
            gap: 0.375rem;
            padding: 0.375rem 0.5rem;
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
            overflow-x: auto;
            flex-shrink: 0;
            -webkit-overflow-scrolling: touch;
        }

        @media (min-width: 480px) {
            .quick-bar {
                gap: 0.5rem;
                padding: 0.5rem 1rem;
            }
        }

        .quick-chip {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 2rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.8rem;
            white-space: nowrap;
            cursor: pointer;
            min-height: 32px;
        }

        @media (min-width: 480px) {
            .quick-chip {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
        }

        .quick-chip:hover {
            border-color: var(--accent-gold);
        }

        /* Dice Panel */
        .dice-panel {
            display: none;
            padding: 1rem;
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
        }

        .dice-panel.visible {
            display: block;
        }

        .dice-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
        }

        @media (max-width: 480px) {
            .dice-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .dice-btn {
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .dice-btn:hover {
            border-color: var(--accent-gold);
            background: rgba(212, 160, 23, 0.1);
        }

        /* Right Panel - NPCs */
        .right-panel {
            width: 240px;
            background: var(--bg-surface);
            border-left: 1px solid var(--border);
            padding: 1rem;
            overflow-y: auto;
        }

        @media (max-width: 1024px) {
            .right-panel {
                display: none;
            }
        }

        .npc-item {
            background: var(--bg-elevated);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .npc-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .npc-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Players list */
        .players-list {
            padding: 0;
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-elevated);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .player-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .player-name {
            font-size: 0.875rem;
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .sidebar-overlay.visible {
            display: block;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        /* Character Screen */
        #character-screen {
            min-height: 100vh;
            background: var(--bg-dark);
            padding: 1rem;
        }

        .char-screen-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .char-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .char-header h2 {
            flex: 1;
            color: var(--accent-gold);
        }

        .char-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .char-loading {
            text-align: center;
            color: var(--text-muted);
            padding: 2rem;
        }

        .char-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .char-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .char-details {
            flex: 1;
        }

        .char-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .char-meta {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .char-hp {
            font-size: 0.75rem;
            color: var(--hp-high);
        }

        .char-delete {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .char-delete:hover {
            background: var(--danger);
            color: white;
        }

        .empty-chars {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        /* Option Grid for Race/Class selection */
        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .option-btn {
            padding: 0.625rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .option-btn:hover {
            border-color: var(--accent-gold);
        }

        .option-btn.selected {
            border-color: var(--accent-gold);
            background: rgba(212, 160, 23, 0.2);
            color: var(--accent-gold);
        }

        .race-info, .class-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 0.5rem;
            background: var(--bg-dark);
            border-radius: 0.375rem;
            min-height: 2.5rem;
        }

        /* Ability Scores */
        .ability-grid {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .ability-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-elevated);
            border-radius: 0.5rem;
        }

        .ability-name {
            width: 40px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .ability-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ability-btn:hover {
            border-color: var(--accent-gold);
        }

        .ability-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ability-value {
            width: 36px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .ability-mod {
            width: 36px;
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Session Code */
        .session-code-display {
            text-align: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-dark);
            border-radius: 0.5rem;
        }

        @media (min-width: 480px) {
            .session-code-display {
                margin-bottom: 1.5rem;
                padding: 1rem;
            }
        }

        .session-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.375rem;
        }

        @media (min-width: 480px) {
            .session-label {
                font-size: 0.875rem;
                margin-bottom: 0.5rem;
            }
        }

        .session-code {
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 0.4rem;
            color: var(--accent-gold);
            font-family: monospace;
        }

        @media (min-width: 480px) {
            .session-code {
                font-size: 2.5rem;
                letter-spacing: 0.5rem;
            }
        }

        .session-input {
            text-transform: uppercase;
            text-align: center;
            font-size: 1.25rem;
            letter-spacing: 0.25rem;
            font-family: monospace;
        }

        @media (min-width: 480px) {
            .session-input {
                font-size: 1.5rem;
                letter-spacing: 0.3rem;
            }
        }

        .header-session-code {
            font-family: monospace;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-gold);
            background: var(--bg-dark);
            padding: 0.25rem 0.375rem;
            border-radius: 0.25rem;
            letter-spacing: 0.1rem;
        }

        @media (min-width: 480px) {
            .header-session-code {
                font-size: 0.875rem;
                padding: 0.25rem 0.5rem;
            }
        }

        .copy-btn {
            margin-top: 0.5rem;
            padding: 0.5rem 1.25rem;
            border: 1px solid var(--accent-gold);
            border-radius: 0.5rem;
            background: transparent;
            color: var(--accent-gold);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        @media (min-width: 480px) {
            .copy-btn {
                margin-top: 0.75rem;
                padding: 0.5rem 1.5rem;
                font-size: 0.875rem;
            }
        }

        .copy-btn:hover {
            background: var(--accent-gold);
            color: var(--bg-dark);
        }

        .copy-btn.copied {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        /* Character Selection in Modals */
        .char-select-list {
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .char-select-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .char-select-item:hover {
            border-color: var(--accent-gold);
        }

        .char-select-item.selected {
            border-color: var(--accent-gold);
            background: rgba(212, 160, 23, 0.1);
        }

        .char-select-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .char-select-info {
            flex: 1;
        }

        .char-select-name {
            font-weight: 600;
        }

        .char-select-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .char-select-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-muted);
        }

        .char-select-empty a {
            color: var(--accent-gold);
            cursor: pointer;
        }

        /* Settings Controls */
        .settings-group {
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .settings-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .settings-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .settings-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 28px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
            background: white;
        }

        .voice-options {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .voice-option {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .voice-option:hover {
            border-color: var(--accent-gold);
        }

        .voice-option.selected {
            border-color: var(--accent-gold);
            background: rgba(212, 160, 23, 0.15);
        }

        .voice-option-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        .voice-test-btn {
            margin-top: 0.75rem;
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--accent-purple);
            border-radius: 0.5rem;
            background: transparent;
            color: var(--accent-purple);
            font-size: 0.875rem;
            cursor: pointer;
        }

        .voice-test-btn:hover {
            background: var(--accent-purple);
            color: white;
        }

        /* ===== CHARACTER SHEET MODAL ===== */
        .sheet-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .sheet-tab {
            flex: 1;
            padding: 0.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 0.25rem 0.25rem 0 0;
            transition: all 0.2s;
        }

        .sheet-tab.active {
            background: var(--bg-elevated);
            color: var(--accent-gold);
            font-weight: 600;
        }

        .sheet-tab:hover:not(.active) {
            background: var(--bg-hover);
        }

        .sheet-content {
            display: none;
            max-height: 50vh;
            overflow-y: auto;
        }

        .sheet-content.active {
            display: block;
        }

        /* Currency Display */
        .currency-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .currency-item {
            text-align: center;
            padding: 0.5rem;
            background: var(--bg-dark);
            border-radius: 0.375rem;
        }

        .currency-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--accent-gold);
        }

        .currency-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .currency-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .currency-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .currency-btn:hover {
            border-color: var(--accent-gold);
        }

        /* Inventory List */
        .inventory-section {
            margin-bottom: 1rem;
        }

        .inventory-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .inventory-list {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .inventory-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-elevated);
            border-radius: 0.375rem;
            font-size: 0.85rem;
        }

        .inventory-item.equipped {
            border-left: 3px solid var(--accent-gold);
        }

        .item-icon {
            font-size: 1rem;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .item-qty {
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 0.125rem 0.375rem;
            background: var(--bg-dark);
            border-radius: 0.25rem;
        }

        .item-actions {
            display: flex;
            gap: 0.25rem;
        }

        .item-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
        }

        .item-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .add-item-btn {
            width: 100%;
            padding: 0.625rem;
            margin-top: 0.5rem;
            border: 1px dashed var(--border);
            border-radius: 0.375rem;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .add-item-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Spell Slots */
        .spell-slots {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-dark);
            border-radius: 0.375rem;
        }

        .slot-group {
            text-align: center;
        }

        .slot-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .slot-pips {
            display: flex;
            gap: 0.125rem;
        }

        .slot-pip {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
        }

        .slot-pip.filled {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
        }

        .spell-list {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .spell-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-elevated);
            border-radius: 0.375rem;
        }

        .spell-level {
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            background: var(--accent-purple);
            color: white;
            border-radius: 0.25rem;
            font-weight: 600;
        }

        .spell-name {
            flex: 1;
            font-size: 0.85rem;
        }

        .cast-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--accent-purple);
            border-radius: 0.25rem;
            background: transparent;
            color: var(--accent-purple);
            font-size: 0.7rem;
            cursor: pointer;
        }

        .cast-btn:hover {
            background: var(--accent-purple);
            color: white;
        }

        .rest-btn {
            width: 100%;
            padding: 0.625rem;
            margin-top: 0.5rem;
            border: 1px solid var(--success);
            border-radius: 0.375rem;
            background: transparent;
            color: var(--success);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .rest-btn:hover {
            background: var(--success);
            color: white;
        }

        /* Party Tab */
        .party-section {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-dark);
            border-radius: 0.375rem;
        }

        .party-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .loot-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem;
            background: var(--bg-elevated);
            border-radius: 0.25rem;
            margin-bottom: 0.25rem;
        }

        .claim-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--accent-gold);
            border-radius: 0.25rem;
            background: transparent;
            color: var(--accent-gold);
            font-size: 0.7rem;
            cursor: pointer;
        }

        .claim-btn:hover {
            background: var(--accent-gold);
            color: var(--bg-dark);
        }

        /* Item Picker Modal */
        .item-picker-search {
            margin-bottom: 0.75rem;
        }

        .item-picker-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 0.75rem;
        }

        .picker-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            margin-bottom: 0.25rem;
            cursor: pointer;
        }

        .picker-item:hover {
            border-color: var(--accent-gold);
        }

        .picker-item.selected {
            border-color: var(--accent-gold);
            background: rgba(212, 160, 23, 0.1);
        }

        /* Quick bar indicators */
        .quick-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.375rem 0.625rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 2rem;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .quick-indicator:hover {
            border-color: var(--accent-gold);
        }

        .gold-indicator {
            color: var(--accent-gold);
        }

        .slots-indicator .slot-mini {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-dark);
            border: 1px solid var(--accent-purple);
        }

        .slots-indicator .slot-mini.filled {
            background: var(--accent-purple);
        }
    </style>
</head>
<body>
    <!-- Title Screen -->
    <div id="title-screen">
        <div class="title-card">
            <div class="game-icon">&#x1F3B2;</div>
            <h1 class="game-title">AI Dungeon Master</h1>
            <p class="game-subtitle">Pathfinder 1st Edition</p>

            <button class="menu-btn primary" id="btn-new-game">&#x25B6; New Game</button>
            <button class="menu-btn" id="btn-join-game">&#x1F517; Join Game</button>

            <div class="menu-divider"></div>

            <button class="menu-btn" id="btn-characters">&#x1F9D9; Manage Characters</button>
            <button class="menu-btn" id="btn-bestiary">&#x1F432; Bestiary</button>
            <button class="menu-btn" id="btn-settings">&#x2699; Settings</button>

            <div class="status-bar">
                <div class="status-item">
                    <span class="status-dot" id="ai-status-dot"></span>
                    <span id="ai-status-text">Checking AI...</span>
                </div>
                <div class="status-item">
                    <span id="version-text">v0.2.0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- New Game Modal (shows session code) -->
    <div class="modal-overlay" id="new-game-modal">
        <div class="modal-card" style="max-width: 450px;">
            <h2 class="modal-title">New Game Created!</h2>
            <div class="session-code-display">
                <div class="session-label">Share this code with your party:</div>
                <div class="session-code" id="new-session-code">----</div>
                <button class="copy-btn" id="btn-copy-code">Copy Code</button>
            </div>
            <div class="form-group">
                <label class="form-label">Select Character</label>
                <div class="char-select-list" id="new-game-char-list">
                    <div class="char-loading">Loading characters...</div>
                </div>
            </div>
            <button class="menu-btn primary" id="btn-start-new">Start Game</button>
            <button class="menu-btn" id="btn-cancel-new">Cancel</button>
        </div>
    </div>

    <!-- Join Game Modal -->
    <div class="modal-overlay" id="join-game-modal">
        <div class="modal-card" style="max-width: 450px;">
            <h2 class="modal-title">Join Game</h2>
            <div class="form-group">
                <label class="form-label" for="join-code">Session Code</label>
                <input type="text" id="join-code" class="form-input session-input" placeholder="ABCD" maxlength="4" autocomplete="off">
            </div>
            <div class="form-group">
                <label class="form-label">Select Character</label>
                <div class="char-select-list" id="join-game-char-list">
                    <div class="char-loading">Loading characters...</div>
                </div>
            </div>
            <button class="menu-btn primary" id="btn-join-session">Join Game</button>
            <button class="menu-btn" id="btn-cancel-join">Cancel</button>
        </div>
    </div>

    <!-- Character Management Screen -->
    <div id="character-screen" style="display: none;">
        <div class="char-screen-container">
            <div class="char-header">
                <button class="header-btn" id="btn-back-to-menu">&#x2190;</button>
                <h2>Manage Characters</h2>
                <button class="menu-btn primary" id="btn-create-new" style="padding: 0.5rem 1rem; width: auto;">+ New</button>
            </div>

            <!-- Character List -->
            <div class="char-list" id="character-list">
                <div class="char-loading">Loading characters...</div>
            </div>
        </div>
    </div>

    <!-- Character Creation Modal -->
    <div class="modal-overlay" id="create-char-modal">
        <div class="modal-card" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <h2 class="modal-title">Create Character</h2>

            <!-- Step 1: Name -->
            <div class="form-group">
                <label class="form-label">Character Name</label>
                <input type="text" id="char-name" class="form-input" placeholder="Enter name...">
            </div>

            <!-- Step 2: Race -->
            <div class="form-group">
                <label class="form-label">Race</label>
                <div class="option-grid" id="race-options"></div>
                <div class="race-info" id="race-info"></div>
            </div>

            <!-- Step 3: Class -->
            <div class="form-group">
                <label class="form-label">Class</label>
                <div class="option-grid" id="class-options"></div>
                <div class="class-info" id="class-info"></div>
            </div>

            <!-- Step 4: Ability Scores -->
            <div class="form-group">
                <label class="form-label">Ability Scores <span style="color: var(--text-muted);">(Points: <span id="points-remaining">20</span>)</span></label>
                <div class="ability-grid">
                    <div class="ability-row">
                        <span class="ability-name">STR</span>
                        <button class="ability-btn" data-ability="strength" data-dir="-">-</button>
                        <span class="ability-value" id="str-value">10</span>
                        <button class="ability-btn" data-ability="strength" data-dir="+">+</button>
                        <span class="ability-mod" id="str-mod">+0</span>
                    </div>
                    <div class="ability-row">
                        <span class="ability-name">DEX</span>
                        <button class="ability-btn" data-ability="dexterity" data-dir="-">-</button>
                        <span class="ability-value" id="dex-value">10</span>
                        <button class="ability-btn" data-ability="dexterity" data-dir="+">+</button>
                        <span class="ability-mod" id="dex-mod">+0</span>
                    </div>
                    <div class="ability-row">
                        <span class="ability-name">CON</span>
                        <button class="ability-btn" data-ability="constitution" data-dir="-">-</button>
                        <span class="ability-value" id="con-value">10</span>
                        <button class="ability-btn" data-ability="constitution" data-dir="+">+</button>
                        <span class="ability-mod" id="con-mod">+0</span>
                    </div>
                    <div class="ability-row">
                        <span class="ability-name">INT</span>
                        <button class="ability-btn" data-ability="intelligence" data-dir="-">-</button>
                        <span class="ability-value" id="int-value">10</span>
                        <button class="ability-btn" data-ability="intelligence" data-dir="+">+</button>
                        <span class="ability-mod" id="int-mod">+0</span>
                    </div>
                    <div class="ability-row">
                        <span class="ability-name">WIS</span>
                        <button class="ability-btn" data-ability="wisdom" data-dir="-">-</button>
                        <span class="ability-value" id="wis-value">10</span>
                        <button class="ability-btn" data-ability="wisdom" data-dir="+">+</button>
                        <span class="ability-mod" id="wis-mod">+0</span>
                    </div>
                    <div class="ability-row">
                        <span class="ability-name">CHA</span>
                        <button class="ability-btn" data-ability="charisma" data-dir="-">-</button>
                        <span class="ability-value" id="cha-value">10</span>
                        <button class="ability-btn" data-ability="charisma" data-dir="+">+</button>
                        <span class="ability-mod" id="cha-mod">+0</span>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button class="menu-btn" id="btn-cancel-create" style="flex: 1;">Cancel</button>
                <button class="menu-btn primary" id="btn-save-char" style="flex: 1;">Create Character</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal-card" style="max-width: 400px;">
            <h2 class="modal-title">Settings</h2>

            <!-- DM Voice Settings -->
            <div class="settings-group">
                <div class="toggle-row">
                    <div>
                        <span class="settings-label">Dungeon Master Voice</span>
                        <span class="settings-desc">Read DM responses aloud</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="setting-voice-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div id="voice-settings-detail" style="display: none;">
                    <div class="voice-options">
                        <button class="voice-option selected" data-voice="male">
                            <span class="voice-option-icon">&#x1F9D9;&#x200D;&#x2642;&#xFE0F;</span>
                            Old Wizard
                        </button>
                        <button class="voice-option" data-voice="female">
                            <span class="voice-option-icon">&#x1F9D9;&#x200D;&#x2640;&#xFE0F;</span>
                            Old Witch
                        </button>
                    </div>
                    <button class="voice-test-btn" id="btn-test-voice">
                        &#x1F50A; Test Voice
                    </button>
                </div>
            </div>

            <button class="menu-btn primary" id="btn-close-settings">Done</button>
        </div>
    </div>

    <!-- Character Sheet Modal -->
    <div class="modal-overlay" id="char-sheet-modal">
        <div class="modal-card char-sheet-card">
            <div class="sheet-header">
                <h2 class="modal-title" id="sheet-char-name">Character Sheet</h2>
                <button class="sheet-close" id="btn-close-sheet">&times;</button>
            </div>

            <div class="sheet-tabs">
                <button class="sheet-tab active" data-tab="stats">Stats</button>
                <button class="sheet-tab" data-tab="inventory">Inventory</button>
                <button class="sheet-tab" data-tab="spells">Spells</button>
                <button class="sheet-tab" data-tab="party">Party</button>
            </div>

            <!-- Stats Tab -->
            <div class="sheet-content active" id="tab-stats">
                <div class="stats-grid">
                    <div class="stat-block">
                        <div class="stat-label">STR</div>
                        <div class="stat-value" id="sheet-str">10</div>
                        <div class="stat-mod" id="sheet-str-mod">+0</div>
                    </div>
                    <div class="stat-block">
                        <div class="stat-label">DEX</div>
                        <div class="stat-value" id="sheet-dex">10</div>
                        <div class="stat-mod" id="sheet-dex-mod">+0</div>
                    </div>
                    <div class="stat-block">
                        <div class="stat-label">CON</div>
                        <div class="stat-value" id="sheet-con">10</div>
                        <div class="stat-mod" id="sheet-con-mod">+0</div>
                    </div>
                    <div class="stat-block">
                        <div class="stat-label">INT</div>
                        <div class="stat-value" id="sheet-int">10</div>
                        <div class="stat-mod" id="sheet-int-mod">+0</div>
                    </div>
                    <div class="stat-block">
                        <div class="stat-label">WIS</div>
                        <div class="stat-value" id="sheet-wis">10</div>
                        <div class="stat-mod" id="sheet-wis-mod">+0</div>
                    </div>
                    <div class="stat-block">
                        <div class="stat-label">CHA</div>
                        <div class="stat-value" id="sheet-cha">10</div>
                        <div class="stat-mod" id="sheet-cha-mod">+0</div>
                    </div>
                </div>

                <div class="combat-stats">
                    <div class="combat-stat">
                        <span class="combat-label">HP</span>
                        <span class="combat-value" id="sheet-hp">10/10</span>
                    </div>
                    <div class="combat-stat">
                        <span class="combat-label">AC</span>
                        <span class="combat-value" id="sheet-ac">10</span>
                    </div>
                    <div class="combat-stat">
                        <span class="combat-label">Initiative</span>
                        <span class="combat-value" id="sheet-init">+0</span>
                    </div>
                </div>

                <div class="currency-section">
                    <h3 class="section-label">Currency</h3>
                    <div class="currency-grid">
                        <div class="currency-item">
                            <span class="currency-icon">&#x25C6;</span>
                            <input type="number" class="currency-value" id="sheet-pp" value="0" min="0">
                            <span class="currency-label">PP</span>
                        </div>
                        <div class="currency-item">
                            <span class="currency-icon gold">&#x25CF;</span>
                            <input type="number" class="currency-value" id="sheet-gp" value="0" min="0">
                            <span class="currency-label">GP</span>
                        </div>
                        <div class="currency-item">
                            <span class="currency-icon silver">&#x25CF;</span>
                            <input type="number" class="currency-value" id="sheet-sp" value="0" min="0">
                            <span class="currency-label">SP</span>
                        </div>
                        <div class="currency-item">
                            <span class="currency-icon copper">&#x25CF;</span>
                            <input type="number" class="currency-value" id="sheet-cp" value="0" min="0">
                            <span class="currency-label">CP</span>
                        </div>
                    </div>
                    <button class="save-currency-btn" id="btn-save-currency">Save Currency</button>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div class="sheet-content" id="tab-inventory">
                <div class="inventory-header">
                    <span class="weight-display">Weight: <span id="inv-weight">0</span> / <span id="inv-capacity">100</span> lbs</span>
                    <button class="add-item-btn" id="btn-add-item">+ Add Item</button>
                </div>

                <div class="inventory-section">
                    <h3 class="section-label">Equipped</h3>
                    <div class="inventory-list" id="equipped-list">
                        <div class="inventory-empty">No items equipped</div>
                    </div>
                </div>

                <div class="inventory-section">
                    <h3 class="section-label">Backpack</h3>
                    <div class="inventory-list" id="backpack-list">
                        <div class="inventory-empty">Backpack is empty</div>
                    </div>
                </div>
            </div>

            <!-- Spells Tab -->
            <div class="sheet-content" id="tab-spells">
                <div class="spell-slots-section">
                    <h3 class="section-label">Spell Slots</h3>
                    <div class="spell-slots" id="spell-slots-display">
                        <div class="slot-level">
                            <span class="slot-label">1st</span>
                            <div class="slot-pips" data-level="1"></div>
                        </div>
                    </div>
                    <button class="rest-btn" id="btn-long-rest">Long Rest (Restore All)</button>
                </div>

                <div class="spells-section">
                    <div class="spells-header">
                        <h3 class="section-label">Known Spells</h3>
                        <button class="add-spell-btn" id="btn-learn-spell">+ Learn Spell</button>
                    </div>
                    <div class="spell-list" id="known-spells-list">
                        <div class="inventory-empty">No spells known</div>
                    </div>
                </div>
            </div>

            <!-- Party Tab -->
            <div class="sheet-content" id="tab-party">
                <div class="party-section">
                    <h3 class="section-label">Party Treasury</h3>
                    <div class="treasury-display">
                        <span class="treasury-gold" id="party-gold">0</span> GP
                    </div>
                    <div class="treasury-actions">
                        <input type="number" id="treasury-amount" placeholder="Amount" min="1" value="10">
                        <button class="treasury-btn" id="btn-contribute">Contribute</button>
                        <button class="treasury-btn" id="btn-withdraw">Withdraw</button>
                    </div>
                </div>

                <div class="party-section">
                    <h3 class="section-label">Party Loot Bag</h3>
                    <div class="loot-list" id="party-loot-list">
                        <div class="inventory-empty">No unclaimed loot</div>
                    </div>
                    <button class="add-item-btn" id="btn-add-loot">+ Add Loot</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Item Picker Modal -->
    <div class="modal-overlay" id="item-picker-modal">
        <div class="modal-card item-picker-card">
            <h2 class="modal-title">Add Item</h2>

            <div class="picker-tabs">
                <button class="picker-tab active" data-picker="common">Common Items</button>
                <button class="picker-tab" data-picker="custom">Custom Item</button>
            </div>

            <div class="picker-content active" id="picker-common">
                <input type="text" class="picker-search" id="item-search" placeholder="Search items...">
                <div class="picker-list" id="common-items-list"></div>
            </div>

            <div class="picker-content" id="picker-custom">
                <input type="text" class="picker-input" id="custom-item-name" placeholder="Item name">
                <div class="picker-row">
                    <input type="number" class="picker-input small" id="custom-item-qty" value="1" min="1" placeholder="Qty">
                    <input type="number" class="picker-input small" id="custom-item-weight" value="1" min="0" step="0.1" placeholder="Weight">
                    <input type="number" class="picker-input small" id="custom-item-value" value="0" min="0" placeholder="GP Value">
                </div>
                <button class="menu-btn primary" id="btn-add-custom-item">Add Custom Item</button>
            </div>

            <button class="menu-btn" id="btn-close-picker">Cancel</button>
        </div>
    </div>

    <!-- Spell Picker Modal -->
    <div class="modal-overlay" id="spell-picker-modal">
        <div class="modal-card item-picker-card">
            <h2 class="modal-title">Learn Spell</h2>
            <input type="text" class="picker-search" id="spell-search" placeholder="Search spells...">
            <select class="picker-select" id="spell-level-filter">
                <option value="">All Levels</option>
                <option value="0">Cantrips</option>
                <option value="1">1st Level</option>
                <option value="2">2nd Level</option>
                <option value="3">3rd Level</option>
                <option value="4">4th Level</option>
                <option value="5">5th Level</option>
            </select>
            <div class="picker-list" id="spell-picker-list"></div>
            <button class="menu-btn" id="btn-close-spell-picker">Cancel</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen">
        <!-- Header -->
        <header class="game-header">
            <button class="header-btn" id="btn-menu">&#x2630;</button>
            <span class="header-session-code" id="header-session-code">----</span>
            <button class="header-char-btn" id="btn-char-sheet" title="Open Character Sheet">
                <span class="char-avatar">&#x1F9D9;</span>
                <span class="char-name-display" id="header-char-name">Character</span>
            </button>
            <div class="location-info">
                <div class="location-name" id="location-name">The Rusty Dragon Inn</div>
                <div class="location-time" id="location-time">Evening</div>
            </div>
            <div class="header-status">
                <span class="status-dot" id="game-status-dot"></span>
                <span id="game-status-text">AI Online</span>
            </div>
            <button class="header-btn" id="btn-players">&#x1F465;</button>
        </header>

        <!-- Main Content -->
        <div class="game-main">
            <!-- Left Sidebar -->
            <aside class="sidebar" id="sidebar">
                <!-- Party Section -->
                <div class="sidebar-section">
                    <div class="section-title">&#x2694; Party</div>
                    <div id="party-list">
                        <div class="party-member">
                            <div class="member-header">
                                <span class="member-name">No Characters</span>
                            </div>
                            <div class="member-class">Create a character to begin</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="sidebar-section">
                    <div class="section-title">&#x26A1; Quick Actions</div>
                    <div class="quick-actions">
                        <button class="action-btn" data-action="I look around carefully, examining my surroundings.">&#x1F441; Look Around</button>
                        <button class="action-btn" data-action="I take a short rest to recover.">&#x1F4A4; Rest</button>
                        <button class="action-btn" data-action="I check my inventory and equipment.">&#x1F392; Inventory</button>
                        <button class="action-btn" data-action="I search the area for hidden items or secrets.">&#x1F50D; Search</button>
                        <button class="action-btn combat" data-action="I draw my weapon and prepare for combat!">&#x2694; Combat</button>
                    </div>
                </div>

                <!-- Players Online -->
                <div class="sidebar-section">
                    <div class="section-title">&#x1F465; Players Online</div>
                    <div class="players-list" id="players-list">
                        <div class="player-item">
                            <span style="color: var(--text-muted); font-size: 0.875rem;">No players connected</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Sidebar Overlay (mobile) -->
            <div class="sidebar-overlay" id="sidebar-overlay"></div>

            <!-- Narrative Area -->
            <main class="narrative-area">
                <div class="narrative-log" id="narrative-log">
                    <div class="narrative-entry entry-dm">
                        <div class="entry-header">&#x1F3AD; Dungeon Master</div>
                        <div class="entry-content">
                            <strong>Welcome, adventurer!</strong><br><br>
                            You find yourself in the common room of the Rusty Dragon Inn. The smell of roasting meat and fresh bread fills the air. Patrons laugh and chat at nearby tables while a bard strums a lute in the corner.<br><br>
                            <em>What would you like to do?</em>
                        </div>
                    </div>
                    <div class="typing-indicator" id="typing-indicator">
                        &#x1F3AD; The Dungeon Master is thinking...
                    </div>
                </div>

                <!-- Dice Panel -->
                <div class="dice-panel" id="dice-panel">
                    <div class="dice-grid">
                        <button class="dice-btn" data-dice="1d4">d4</button>
                        <button class="dice-btn" data-dice="1d6">d6</button>
                        <button class="dice-btn" data-dice="1d8">d8</button>
                        <button class="dice-btn" data-dice="1d10">d10</button>
                        <button class="dice-btn" data-dice="1d12">d12</button>
                        <button class="dice-btn" data-dice="1d20">d20</button>
                    </div>
                </div>

                <!-- Quick Bar -->
                <div class="quick-bar">
                    <span class="quick-indicator gold-indicator" id="quick-gold" title="Gold">&#x25CF; <span id="quick-gold-val">0</span>g</span>
                    <span class="quick-indicator slots-indicator" id="quick-slots" title="Spell Slots"><span id="quick-slots-val">-</span></span>
                    <button class="quick-chip" id="btn-dice-toggle">&#x1F3B2; Roll Dice</button>
                    <button class="quick-chip" data-action="I talk to the bartender.">&#x1F5E3; Talk</button>
                    <button class="quick-chip" data-action="I order a drink.">&#x1F37A; Drink</button>
                    <button class="quick-chip" data-action="I listen for rumors.">&#x1F442; Listen</button>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-row">
                        <textarea class="action-input" id="action-input" rows="1" placeholder="What do you do?"></textarea>
                        <button class="input-btn" id="stop-audio-btn" title="Stop audio" style="display: none;">&#x23F9;</button>
                        <button class="input-btn" id="voice-btn" title="Hold to speak">&#x1F3A4;</button>
                        <button class="input-btn" id="send-btn">&#x27A4;</button>
                    </div>
                </div>
            </main>

            <!-- Right Panel - NPCs -->
            <aside class="right-panel">
                <div class="section-title">&#x1F9D1; NPCs Nearby</div>
                <div id="npc-list">
                    <div class="npc-item">
                        <div class="npc-name">Ameiko Kaijitsu</div>
                        <div class="npc-desc">Innkeeper, standing behind the bar</div>
                    </div>
                    <div class="npc-item">
                        <div class="npc-name">Traveling Merchant</div>
                        <div class="npc-desc">Sitting alone, counting coins</div>
                    </div>
                    <div class="npc-item">
                        <div class="npc-name">Local Bard</div>
                        <div class="npc-desc">Playing a lute in the corner</div>
                    </div>
                </div>

                <div class="section-title" style="margin-top: 1.5rem;">&#x1F4DC; Active Quests</div>
                <div id="quest-list">
                    <div class="npc-item">
                        <div class="npc-name">A New Beginning</div>
                        <div class="npc-desc">Find adventure in Sandpoint</div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // State
        const state = {
            playerName: '',
            sessionCode: '',
            selectedCharacter: null,
            ws: null,
            connected: false,
            // Voice recording with VAD
            recording: false,
            listening: false, // Waiting for speech
            mediaRecorder: null,
            audioChunks: [],
            audioContext: null,
            analyser: null,
            audioStream: null,
            silenceTimer: null,
            speechDetected: false,
            aiAvailable: false,
            speechAvailable: false,
        };

        // Voice Activity Detection settings
        const VAD_CONFIG = {
            silenceThreshold: 15,      // Audio level below this = silence (0-128)
            silenceDuration: 1500,      // ms of silence before auto-submit
            minSpeechDuration: 300,     // Minimum ms of speech before considering it valid
        };

        // DM Voice (Text-to-Speech) settings
        const dmVoice = {
            enabled: localStorage.getItem('dmVoiceEnabled') === 'true',
            gender: localStorage.getItem('dmVoiceGender') || 'male',
            usePiper: localStorage.getItem('dmVoiceUsePiper') !== 'false',  // Default to Piper if available
            speaking: false,
        };

        // Audio element and queue for Piper TTS playback
        const dmAudioElement = new Audio();
        const audioQueue = [];
        let audioPlaying = false;

        function playNextInQueue() {
            if (audioQueue.length === 0) {
                audioPlaying = false;
                dmVoice.speaking = false;
                document.getElementById('stop-audio-btn').style.display = 'none';
                return;
            }
            audioPlaying = true;
            const { audio, format } = audioQueue.shift();
            dmAudioElement.src = `data:audio/${format};base64,${audio}`;
            dmAudioElement.play().catch(e => {
                console.warn('Audio playback error:', e);
                playNextInQueue();  // Try next chunk
            });
        }

        dmAudioElement.onended = () => {
            playNextInQueue();
        };
        dmAudioElement.onerror = () => {
            playNextInQueue();  // Skip to next on error
        };

        // Elements
        const titleScreen = document.getElementById('title-screen');
        const gameScreen = document.getElementById('game-screen');
        const newGameModal = document.getElementById('new-game-modal');
        const joinGameModal = document.getElementById('join-game-modal');
        const narrativeLog = document.getElementById('narrative-log');
        const actionInput = document.getElementById('action-input');
        const typingIndicator = document.getElementById('typing-indicator');
        const dicePanel = document.getElementById('dice-panel');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        // Check server status
        async function checkStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                state.aiAvailable = data.ai_available;
                state.speechAvailable = data.speech_available;

                // Update title screen status
                const dot = document.getElementById('ai-status-dot');
                const text = document.getElementById('ai-status-text');
                dot.classList.toggle('offline', !data.ai_available);
                text.textContent = data.ai_available ? 'AI Online' : 'AI Offline';

                // Update game screen status
                const gameDot = document.getElementById('game-status-dot');
                const gameText = document.getElementById('game-status-text');
                if (gameDot) {
                    gameDot.classList.toggle('offline', !data.ai_available);
                    gameText.textContent = data.ai_available ? 'AI Online' : 'AI Offline';
                }

                // Voice button
                const voiceBtn = document.getElementById('voice-btn');
                voiceBtn.style.opacity = data.speech_available ? '1' : '0.5';
                voiceBtn.title = data.speech_available ? 'Tap to speak' : 'Voice unavailable';
            } catch (e) {
                document.getElementById('ai-status-dot').classList.add('offline');
                document.getElementById('ai-status-text').textContent = 'Server Offline';
            }
        }

        // Connect WebSocket
        function connect() {
            // Use wss:// for HTTPS, ws:// for HTTP
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/${state.sessionCode}/${state.playerName}`;
            state.ws = new WebSocket(wsUrl);

            state.ws.onopen = () => {
                state.connected = true;
                console.log('Connected to server');
            };

            state.ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };

            state.ws.onclose = () => {
                state.connected = false;
                console.log('Disconnected');
                setTimeout(connect, 3000);
            };

            state.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Handle incoming messages
        function handleMessage(data) {
            switch (data.type) {
                case 'connected':
                    document.getElementById('location-name').textContent = data.location || 'Unknown Location';
                    if (data.session_code) {
                        document.getElementById('header-session-code').textContent = data.session_code;
                    }
                    break;

                case 'player_joined':
                    addSystemEntry(`${data.player_name} joined the adventure`);
                    updatePlayersList(data.players || []);
                    break;

                case 'player_left':
                    addSystemEntry(`${data.player_name} left the game`);
                    updatePlayersList(data.players || []);
                    break;

                case 'player_action':
                    if (data.player !== state.playerName) {
                        addPlayerEntry(data.player, data.action);
                    }
                    break;

                case 'dm_typing':
                    typingIndicator.classList.toggle('visible', data.status);
                    scrollToBottom();
                    break;

                case 'dm_response_stream':
                    updateStreamingEntry(data.token);
                    break;

                case 'dm_response':
                    typingIndicator.classList.remove('visible');
                    finalizeStreamingEntry(data.content);
                    break;

                case 'dm_audio':
                    playDMAudio(data.audio, data.format);
                    break;

                case 'dm_audio_chunk':
                    queueAudioChunk(data.audio, data.format, data.index);
                    break;

                case 'dice_roll':
                    addDiceEntry(data.player, data.notation, data.result, data.rolls);
                    break;

                case 'chat':
                    addPlayerEntry(data.player, data.content);
                    break;

                case 'error':
                    addSystemEntry(`Error: ${data.message}`);
                    break;
            }
        }

        // Narrative entries
        let streamingEntry = null;

        function addDMEntry(content) {
            const entry = document.createElement('div');
            entry.className = 'narrative-entry entry-dm';
            entry.innerHTML = `
                <div class="entry-header">&#x1F3AD; Dungeon Master</div>
                <div class="entry-content">${escapeHtml(content)}</div>
            `;
            narrativeLog.insertBefore(entry, typingIndicator);
            scrollToBottom();
        }

        function addPlayerEntry(player, content) {
            const entry = document.createElement('div');
            entry.className = 'narrative-entry entry-player';
            entry.innerHTML = `
                <div class="entry-header">&#x2694; ${escapeHtml(player)}</div>
                <div class="entry-content">${escapeHtml(content)}</div>
            `;
            narrativeLog.insertBefore(entry, typingIndicator);
            scrollToBottom();
        }

        function addSystemEntry(content) {
            const entry = document.createElement('div');
            entry.className = 'narrative-entry entry-system';
            entry.textContent = content;
            narrativeLog.insertBefore(entry, typingIndicator);
            scrollToBottom();
        }

        function addDiceEntry(player, notation, result, rolls) {
            const entry = document.createElement('div');
            entry.className = 'narrative-entry';
            entry.innerHTML = `
                <div class="entry-dice">
                    &#x1F3B2; ${escapeHtml(player)} rolled ${notation}:
                    <span class="dice-result">${result}</span>
                    <span style="color: var(--text-muted);">[${rolls.join(', ')}]</span>
                </div>
            `;
            narrativeLog.insertBefore(entry, typingIndicator);
            scrollToBottom();
        }

        function updateStreamingEntry(token) {
            if (!streamingEntry) {
                streamingEntry = document.createElement('div');
                streamingEntry.className = 'narrative-entry entry-dm';
                streamingEntry.innerHTML = `
                    <div class="entry-header">&#x1F3AD; Dungeon Master</div>
                    <div class="entry-content"></div>
                `;
                narrativeLog.insertBefore(streamingEntry, typingIndicator);
            }
            const content = streamingEntry.querySelector('.entry-content');
            content.textContent += token;
            scrollToBottom();
        }

        function finalizeStreamingEntry(fullContent) {
            if (streamingEntry) {
                const content = streamingEntry.querySelector('.entry-content');
                content.textContent = fullContent;
                streamingEntry = null;
            } else {
                addDMEntry(fullContent);
            }
            scrollToBottom();

            // Speak DM response if voice is enabled
            speakDMText(fullContent);
        }

        function scrollToBottom() {
            narrativeLog.scrollTop = narrativeLog.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Queue audio chunk for streaming TTS
        function queueAudioChunk(audioBase64, format, index) {
            if (!dmVoice.enabled) return;

            audioQueue.push({ audio: audioBase64, format, index });
            dmVoice.speaking = true;
            document.getElementById('stop-audio-btn').style.display = 'block';

            // Start playback if not already playing
            if (!audioPlaying) {
                playNextInQueue();
            }
        }

        // Play Piper TTS audio from server (full response, legacy)
        function playDMAudio(audioBase64, format) {
            if (!dmVoice.enabled) return;

            // Stop any current audio and clear queue
            stopDMAudio();

            try {
                dmVoice.speaking = true;
                audioPlaying = true;
                document.getElementById('stop-audio-btn').style.display = 'block';
                dmAudioElement.src = `data:audio/${format};base64,${audioBase64}`;
                dmAudioElement.play().catch(e => {
                    console.warn('Audio autoplay blocked:', e);
                    dmVoice.speaking = false;
                    audioPlaying = false;
                    document.getElementById('stop-audio-btn').style.display = 'none';
                });
            } catch (e) {
                console.error('Failed to play DM audio:', e);
                dmVoice.speaking = false;
                audioPlaying = false;
                document.getElementById('stop-audio-btn').style.display = 'none';
            }
        }

        // Stop all DM audio (Piper and browser TTS)
        function stopDMAudio() {
            // Stop Piper audio and clear queue
            dmAudioElement.pause();
            dmAudioElement.currentTime = 0;
            audioQueue.length = 0;  // Clear pending chunks
            audioPlaying = false;

            // Stop browser TTS
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }

            dmVoice.speaking = false;
            document.getElementById('stop-audio-btn').style.display = 'none';
        }

        // Text-to-Speech for DM voice (fallback when Piper unavailable)
        function speakDMText(text) {
            // Skip browser TTS if Piper is enabled (audio comes via WebSocket)
            if (dmVoice.usePiper) return;
            if (!dmVoice.enabled || !('speechSynthesis' in window)) return;

            // Cancel any ongoing speech
            speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);

            // Get available voices
            let voices = speechSynthesis.getVoices();

            // Voices might not be loaded yet on some browsers
            if (voices.length === 0) {
                // Wait for voices and retry once
                setTimeout(() => {
                    voices = speechSynthesis.getVoices();
                    if (voices.length > 0) speakWithVoices(utterance, text);
                }, 100);
                return;
            }

            speakWithVoices(utterance, text);
        }

        function speakWithVoices(utterance, text) {
            const voices = speechSynthesis.getVoices();

            // Keywords to identify male vs female voices
            const maleKeywords = ['male', 'david', 'james', 'mark', 'paul', 'daniel', 'george', 'alex', 'tom', 'fred', 'albert', 'guy'];
            const femaleKeywords = ['female', 'zira', 'susan', 'linda', 'samantha', 'karen', 'victoria', 'fiona', 'moira', 'tessa', 'kate', 'serena', 'ellen', 'ava'];

            const targetKeywords = dmVoice.gender === 'male' ? maleKeywords : femaleKeywords;
            const avoidKeywords = dmVoice.gender === 'male' ? femaleKeywords : maleKeywords;

            // Filter to English voices
            const englishVoices = voices.filter(v => v.lang.startsWith('en'));

            // Score voices based on how well they match our criteria
            let bestVoice = null;
            let bestScore = -100;

            for (const voice of englishVoices) {
                const nameLower = voice.name.toLowerCase();
                let score = 0;

                // Prefer matching gender
                for (const keyword of targetKeywords) {
                    if (nameLower.includes(keyword)) score += 10;
                }
                // Avoid opposite gender
                for (const keyword of avoidKeywords) {
                    if (nameLower.includes(keyword)) score -= 20;
                }
                // Slight preference for US/GB voices
                if (voice.lang === 'en-US' || voice.lang === 'en-GB') score += 2;

                if (score > bestScore) {
                    bestScore = score;
                    bestVoice = voice;
                }
            }

            // Fallback to first English voice or any voice
            if (!bestVoice) {
                bestVoice = englishVoices[0] || voices[0];
            }

            if (bestVoice) {
                utterance.voice = bestVoice;
            }

            // ELDERLY VOICE EFFECT - very pronounced differences
            if (dmVoice.gender === 'male') {
                // Old Wizard: Very deep, slow, deliberate
                utterance.rate = 0.7;    // Much slower - wise, deliberate speech
                utterance.pitch = 0.5;   // Very low pitch - deep old man voice
            } else {
                // Old Witch: Slower, lower, mysterious
                utterance.rate = 0.75;   // Slower
                utterance.pitch = 0.7;   // Lower than normal - old woman voice
            }

            dmVoice.speaking = true;
            utterance.onend = () => { dmVoice.speaking = false; };
            utterance.onerror = () => { dmVoice.speaking = false; };

            speechSynthesis.speak(utterance);
        }

        function testDMVoice() {
            const testPhrases = [
                "Welcome, brave adventurer, to the realm of endless possibilities.",
                "Roll for initiative! The goblins are upon you!",
                "You find a dusty tome in the ancient library.",
                "The dragon's eyes gleam with ancient wisdom.",
            ];
            const phrase = testPhrases[Math.floor(Math.random() * testPhrases.length)];
            speakDMText(phrase);
        }

        // Initialize voices (needed for some browsers)
        if ('speechSynthesis' in window) {
            speechSynthesis.getVoices();
            speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
        }

        function updatePlayersList(players) {
            const list = document.getElementById('players-list');
            if (players.length === 0) {
                list.innerHTML = '<div class="player-item"><span style="color: var(--text-muted); font-size: 0.875rem;">No players connected</span></div>';
            } else {
                list.innerHTML = players.map(name => `
                    <div class="player-item">
                        <div class="player-avatar">${name.charAt(0).toUpperCase()}</div>
                        <span class="player-name">${escapeHtml(name)}</span>
                    </div>
                `).join('');
            }
        }

        // Send action
        function sendAction() {
            const action = actionInput.value.trim();
            if (!action) return;

            if (!state.connected) {
                addSystemEntry('Not connected - trying to reconnect...');
                connect();
                // Retry after a short delay
                setTimeout(() => {
                    if (state.connected && actionInput.value.trim()) {
                        sendAction();
                    }
                }, 1000);
                return;
            }

            addPlayerEntry(state.playerName, action);
            state.ws.send(JSON.stringify({
                type: 'player_action',
                action: action,
            }));

            actionInput.value = '';
            actionInput.style.height = 'auto';
        }

        // Roll dice
        function rollDice(notation) {
            if (!state.connected) return;
            state.ws.send(JSON.stringify({
                type: 'dice_roll',
                notation: notation,
            }));
            dicePanel.classList.remove('visible');
        }

        // Voice recording with VAD (Voice Activity Detection)
        async function toggleVoiceRecording() {
            const voiceBtn = document.getElementById('voice-btn');

            if (state.listening || state.recording) {
                // Stop recording
                stopVoiceRecording(false); // Cancel without submitting
                return;
            }

            try {
                // Request microphone
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.audioStream = stream;

                // Set up audio analysis for VAD
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                state.analyser = state.audioContext.createAnalyser();
                state.analyser.fftSize = 256;

                const source = state.audioContext.createMediaStreamSource(stream);
                source.connect(state.analyser);

                // Set up MediaRecorder
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];

                state.mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        state.audioChunks.push(e.data);
                    }
                };

                state.mediaRecorder.onstop = async () => {
                    if (state.speechDetected && state.audioChunks.length > 0) {
                        const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                        await transcribeAudio(audioBlob);
                    }
                    cleanupVoice();
                };

                // Start recording and listening
                state.mediaRecorder.start(100); // Collect data every 100ms
                state.listening = true;
                state.recording = false;
                state.speechDetected = false;

                voiceBtn.classList.add('listening');
                voiceBtn.title = 'Listening... Tap to cancel';

                // Start monitoring audio levels
                monitorAudioLevels();

            } catch (e) {
                console.error('Recording error:', e);
                addSystemEntry('Microphone access denied');
                cleanupVoice();
            }
        }

        function monitorAudioLevels() {
            if (!state.analyser || (!state.listening && !state.recording)) {
                return;
            }

            const dataArray = new Uint8Array(state.analyser.frequencyBinCount);
            state.analyser.getByteFrequencyData(dataArray);

            // Calculate average audio level
            const average = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;

            const voiceBtn = document.getElementById('voice-btn');

            if (average > VAD_CONFIG.silenceThreshold) {
                // Speech detected
                if (!state.speechDetected) {
                    state.speechDetected = true;
                    state.recording = true;
                    state.speechStartTime = Date.now();
                    voiceBtn.classList.remove('listening');
                    voiceBtn.classList.add('recording');
                }

                // Clear silence timer
                if (state.silenceTimer) {
                    clearTimeout(state.silenceTimer);
                    state.silenceTimer = null;
                }
            } else if (state.speechDetected) {
                // Silence after speech - start timer
                if (!state.silenceTimer) {
                    state.silenceTimer = setTimeout(() => {
                        // Check if we had enough speech
                        const speechDuration = Date.now() - state.speechStartTime;
                        if (speechDuration >= VAD_CONFIG.minSpeechDuration) {
                            stopVoiceRecording(true); // Auto-submit
                        } else {
                            // Too short, keep listening
                            state.speechDetected = false;
                            state.recording = false;
                            voiceBtn.classList.remove('recording');
                            voiceBtn.classList.add('listening');
                            state.audioChunks = [];
                        }
                    }, VAD_CONFIG.silenceDuration);
                }
            }

            // Continue monitoring
            if (state.listening || state.recording) {
                requestAnimationFrame(monitorAudioLevels);
            }
        }

        function stopVoiceRecording(submit) {
            const voiceBtn = document.getElementById('voice-btn');

            if (state.silenceTimer) {
                clearTimeout(state.silenceTimer);
                state.silenceTimer = null;
            }

            if (!submit) {
                state.speechDetected = false;
                state.audioChunks = [];
            }

            if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
                state.mediaRecorder.stop();
            } else {
                cleanupVoice();
            }

            voiceBtn.classList.remove('recording', 'listening');
            voiceBtn.title = 'Tap to speak';
        }

        function cleanupVoice() {
            state.listening = false;
            state.recording = false;

            if (state.audioStream) {
                state.audioStream.getTracks().forEach(track => track.stop());
                state.audioStream = null;
            }

            if (state.audioContext) {
                state.audioContext.close().catch(() => {});
                state.audioContext = null;
                state.analyser = null;
            }
        }

        async function transcribeAudio(audioBlob) {
            addSystemEntry('Transcribing...');
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'voice.webm');

                const res = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData,
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.text && data.text.trim()) {
                        actionInput.value = data.text.trim();
                        sendAction();
                    } else {
                        addSystemEntry('No speech detected');
                    }
                } else if (res.status === 503) {
                    addSystemEntry('Voice not available');
                } else {
                    addSystemEntry('Transcription failed');
                }
            } catch (e) {
                console.error('Transcription error:', e);
                addSystemEntry('Transcription error');
            }
        }

        // Start game with session
        function startGame() {
            titleScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
            document.getElementById('header-session-code').textContent = state.sessionCode;
            // Update header character name
            if (state.selectedCharacter) {
                document.getElementById('header-char-name').textContent = state.selectedCharacter.name;
            }
            connect();
            // Update quick bar indicators after a short delay
            setTimeout(updateQuickBarIndicators, 500);
        }

        // Load characters for selection
        async function loadCharactersForSelect(containerId) {
            const container = document.getElementById(containerId);
            try {
                const res = await fetch('/api/characters');
                const data = await res.json();

                if (data.characters.length === 0) {
                    container.innerHTML = `
                        <div class="char-select-empty">
                            No characters yet.<br>
                            <a onclick="goToCharacterScreen()">Create one first</a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.characters.map(char => `
                    <div class="char-select-item" data-id="${char.id}" data-name="${escapeHtml(char.name)}">
                        <div class="char-select-avatar">&#x1F9D9;</div>
                        <div class="char-select-info">
                            <div class="char-select-name">${escapeHtml(char.name)}</div>
                            <div class="char-select-meta">${char.race} ${char.character_class} Lv${char.level}</div>
                        </div>
                    </div>
                `).join('');

                container.querySelectorAll('.char-select-item').forEach(item => {
                    item.addEventListener('click', () => {
                        container.querySelectorAll('.char-select-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        state.selectedCharacter = {
                            id: item.dataset.id,
                            name: item.dataset.name
                        };
                    });
                });

                // Auto-select first character
                const first = container.querySelector('.char-select-item');
                if (first) {
                    first.click();
                }
            } catch (e) {
                console.error('Failed to load characters:', e);
                container.innerHTML = '<div class="char-loading">Failed to load characters</div>';
            }
        }

        function goToCharacterScreen() {
            newGameModal.classList.remove('visible');
            joinGameModal.classList.remove('visible');
            titleScreen.style.display = 'none';
            document.getElementById('character-screen').style.display = 'block';
            loadCharacters();
            loadRacesAndClasses();
        }

        // Create new session
        async function createNewSession() {
            try {
                const res = await fetch('/api/sessions', { method: 'POST' });
                const data = await res.json();
                state.sessionCode = data.code;
                state.selectedCharacter = null;
                document.getElementById('new-session-code').textContent = data.code;
                newGameModal.classList.add('visible');
                loadCharactersForSelect('new-game-char-list');
            } catch (e) {
                console.error('Failed to create session:', e);
                alert('Failed to create session');
            }
        }

        // Event Listeners - New Game
        document.getElementById('btn-new-game').addEventListener('click', createNewSession);

        document.getElementById('btn-start-new').addEventListener('click', () => {
            if (!state.selectedCharacter) {
                alert('Please select a character');
                return;
            }
            state.playerName = state.selectedCharacter.name;
            newGameModal.classList.remove('visible');
            startGame();
        });

        document.getElementById('btn-cancel-new').addEventListener('click', () => {
            newGameModal.classList.remove('visible');
        });

        document.getElementById('btn-copy-code').addEventListener('click', async () => {
            const code = state.sessionCode;
            const btn = document.getElementById('btn-copy-code');
            try {
                await navigator.clipboard.writeText(code);
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Code';
                    btn.classList.remove('copied');
                }, 2000);
            } catch (e) {
                // Fallback for older browsers
                const input = document.createElement('input');
                input.value = code;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Code';
                    btn.classList.remove('copied');
                }, 2000);
            }
        });

        // Event Listeners - Join Game
        document.getElementById('btn-join-game').addEventListener('click', () => {
            state.selectedCharacter = null;
            joinGameModal.classList.add('visible');
            loadCharactersForSelect('join-game-char-list');
            document.getElementById('join-code').focus();
        });

        document.getElementById('btn-join-session').addEventListener('click', async () => {
            const code = document.getElementById('join-code').value.trim().toUpperCase();

            if (!code || code.length !== 4) {
                document.getElementById('join-code').focus();
                return;
            }
            if (!state.selectedCharacter) {
                alert('Please select a character');
                return;
            }

            // Verify session exists
            try {
                const res = await fetch(`/api/sessions/${code}`);
                if (!res.ok) {
                    alert('Session not found. Check the code and try again.');
                    return;
                }
            } catch (e) {
                alert('Failed to verify session');
                return;
            }

            state.sessionCode = code;
            state.playerName = state.selectedCharacter.name;
            joinGameModal.classList.remove('visible');
            startGame();
        });

        document.getElementById('btn-cancel-join').addEventListener('click', () => {
            joinGameModal.classList.remove('visible');
        });

        document.getElementById('join-code').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        document.getElementById('join-code').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('btn-join-session').click();
        });

        document.getElementById('send-btn').addEventListener('click', sendAction);
        document.getElementById('stop-audio-btn').addEventListener('click', stopDMAudio);
        actionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAction();
            }
        });

        actionInput.addEventListener('input', () => {
            actionInput.style.height = 'auto';
            actionInput.style.height = Math.min(actionInput.scrollHeight, 120) + 'px';
            // Stop audio when user starts typing
            if (dmVoice.speaking) {
                stopDMAudio();
            }
        });

        // Voice button - tap to toggle recording with VAD
        const voiceBtn = document.getElementById('voice-btn');
        voiceBtn.addEventListener('click', toggleVoiceRecording);
        voiceBtn.title = 'Tap to speak';

        // Dice toggle
        document.getElementById('btn-dice-toggle').addEventListener('click', () => {
            dicePanel.classList.toggle('visible');
        });

        // Dice buttons
        document.querySelectorAll('.dice-btn').forEach(btn => {
            btn.addEventListener('click', () => rollDice(btn.dataset.dice));
        });

        // Quick actions and chips
        document.querySelectorAll('.action-btn, .quick-chip[data-action]').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.dataset.action && state.connected) {
                    actionInput.value = btn.dataset.action;
                    sendAction();
                    sidebar.classList.remove('visible');
                    sidebarOverlay.classList.remove('visible');
                }
            });
        });

        // Mobile sidebar toggle
        document.getElementById('btn-menu').addEventListener('click', () => {
            sidebar.classList.add('visible');
            sidebarOverlay.classList.add('visible');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('visible');
            sidebarOverlay.classList.remove('visible');
        });

        // ===== CHARACTER CREATION =====
        const characterScreen = document.getElementById('character-screen');
        const createCharModal = document.getElementById('create-char-modal');
        const characterList = document.getElementById('character-list');

        // Character creation state
        const charState = {
            races: [],
            classes: [],
            selectedRace: null,
            selectedClass: null,
            abilities: {
                strength: 10,
                dexterity: 10,
                constitution: 10,
                intelligence: 10,
                wisdom: 10,
                charisma: 10
            },
            pointsUsed: 0,
            maxPoints: 20
        };

        // Point buy cost table (Pathfinder)
        const pointCost = {
            7: -4, 8: -2, 9: -1, 10: 0, 11: 1, 12: 2, 13: 3, 14: 5, 15: 7, 16: 10, 17: 13, 18: 17
        };

        function calculatePointsUsed() {
            let total = 0;
            for (const ability of Object.values(charState.abilities)) {
                total += pointCost[ability] || 0;
            }
            return total;
        }

        function updatePointsDisplay() {
            charState.pointsUsed = calculatePointsUsed();
            const remaining = charState.maxPoints - charState.pointsUsed;
            document.getElementById('points-remaining').textContent = remaining;
            document.getElementById('points-remaining').style.color = remaining < 0 ? 'var(--danger)' : 'var(--text-primary)';
        }

        function updateAbilityDisplay(ability) {
            const abbrev = ability.substring(0, 3);
            const value = charState.abilities[ability];
            const mod = Math.floor((value - 10) / 2);
            document.getElementById(`${abbrev}-value`).textContent = value;
            document.getElementById(`${abbrev}-mod`).textContent = mod >= 0 ? `+${mod}` : mod;
        }

        function adjustAbility(ability, direction) {
            const current = charState.abilities[ability];
            const newValue = direction === '+' ? current + 1 : current - 1;

            if (newValue < 7 || newValue > 18) return;

            // Check if we have enough points
            charState.abilities[ability] = newValue;
            const newPointsUsed = calculatePointsUsed();

            if (newPointsUsed > charState.maxPoints && direction === '+') {
                charState.abilities[ability] = current;
                return;
            }

            updateAbilityDisplay(ability);
            updatePointsDisplay();
        }

        // Load races and classes
        async function loadRacesAndClasses() {
            try {
                const [racesRes, classesRes] = await Promise.all([
                    fetch('/api/races'),
                    fetch('/api/classes')
                ]);
                const racesData = await racesRes.json();
                const classesData = await classesRes.json();

                charState.races = racesData.races;
                charState.classes = classesData.classes;

                renderRaceOptions();
                renderClassOptions();
            } catch (e) {
                console.error('Failed to load races/classes:', e);
            }
        }

        function renderRaceOptions() {
            const container = document.getElementById('race-options');
            container.innerHTML = charState.races.map(race => `
                <button class="option-btn" data-race="${race.name}">${race.name}</button>
            `).join('');

            container.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    container.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    charState.selectedRace = charState.races.find(r => r.name === btn.dataset.race);
                    document.getElementById('race-info').textContent = charState.selectedRace?.description || '';
                });
            });
        }

        function renderClassOptions() {
            const container = document.getElementById('class-options');
            container.innerHTML = charState.classes.map(cls => `
                <button class="option-btn" data-class="${cls.name}">${cls.name}</button>
            `).join('');

            container.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    container.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    charState.selectedClass = charState.classes.find(c => c.name === btn.dataset.class);
                    const cls = charState.selectedClass;
                    document.getElementById('class-info').textContent = cls ? `${cls.description} (d${cls.hit_die} HP)` : '';
                });
            });
        }

        async function loadCharacters() {
            try {
                const res = await fetch('/api/characters');
                const data = await res.json();
                renderCharacterList(data.characters);
            } catch (e) {
                console.error('Failed to load characters:', e);
                characterList.innerHTML = '<div class="char-loading">Failed to load characters</div>';
            }
        }

        function renderCharacterList(characters) {
            if (characters.length === 0) {
                characterList.innerHTML = `
                    <div class="empty-chars">
                        <p>No characters yet</p>
                        <p style="font-size: 0.875rem;">Create your first character to begin adventuring!</p>
                    </div>
                `;
                return;
            }

            characterList.innerHTML = characters.map(char => `
                <div class="char-card" data-id="${char.id}">
                    <div class="char-avatar">&#x1F9D9;</div>
                    <div class="char-details">
                        <div class="char-name">${escapeHtml(char.name)}</div>
                        <div class="char-meta">${char.race} ${char.character_class} Lv${char.level}</div>
                        <div class="char-hp">HP: ${char.current_hp}/${char.max_hp}</div>
                    </div>
                    <button class="char-delete" data-id="${char.id}">Delete</button>
                </div>
            `).join('');

            characterList.querySelectorAll('.char-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (confirm('Delete this character?')) {
                        await deleteCharacter(btn.dataset.id);
                    }
                });
            });
        }

        async function deleteCharacter(id) {
            try {
                await fetch(`/api/characters/${id}`, { method: 'DELETE' });
                loadCharacters();
            } catch (e) {
                console.error('Failed to delete character:', e);
            }
        }

        function resetCharacterForm() {
            document.getElementById('char-name').value = '';
            charState.selectedRace = null;
            charState.selectedClass = null;
            charState.abilities = { strength: 10, dexterity: 10, constitution: 10, intelligence: 10, wisdom: 10, charisma: 10 };

            document.querySelectorAll('#race-options .option-btn, #class-options .option-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('race-info').textContent = '';
            document.getElementById('class-info').textContent = '';

            ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'].forEach(updateAbilityDisplay);
            updatePointsDisplay();
        }

        async function saveCharacter() {
            const name = document.getElementById('char-name').value.trim();
            if (!name) {
                alert('Please enter a character name');
                return;
            }
            if (!charState.selectedRace) {
                alert('Please select a race');
                return;
            }
            if (!charState.selectedClass) {
                alert('Please select a class');
                return;
            }
            if (charState.pointsUsed > charState.maxPoints) {
                alert('You have used too many points');
                return;
            }

            try {
                const res = await fetch('/api/characters', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        race: charState.selectedRace.name,
                        character_class: charState.selectedClass.name,
                        ...charState.abilities
                    })
                });

                if (res.ok) {
                    createCharModal.classList.remove('visible');
                    loadCharacters();
                } else {
                    const error = await res.json();
                    alert(error.detail || 'Failed to create character');
                }
            } catch (e) {
                console.error('Failed to save character:', e);
                alert('Failed to create character');
            }
        }

        // Character screen event listeners
        document.getElementById('btn-characters').addEventListener('click', () => {
            titleScreen.style.display = 'none';
            characterScreen.style.display = 'block';
            loadCharacters();
            loadRacesAndClasses();
        });

        document.getElementById('btn-back-to-menu').addEventListener('click', () => {
            characterScreen.style.display = 'none';
            titleScreen.style.display = 'flex';
        });

        document.getElementById('btn-create-new').addEventListener('click', () => {
            resetCharacterForm();
            createCharModal.classList.add('visible');
        });

        document.getElementById('btn-cancel-create').addEventListener('click', () => {
            createCharModal.classList.remove('visible');
        });

        document.getElementById('btn-save-char').addEventListener('click', saveCharacter);

        // Ability score buttons
        document.querySelectorAll('.ability-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                adjustAbility(btn.dataset.ability, btn.dataset.dir);
            });
        });

        // ===== SETTINGS =====
        const settingsModal = document.getElementById('settings-modal');
        const voiceEnabledToggle = document.getElementById('setting-voice-enabled');
        const voiceSettingsDetail = document.getElementById('voice-settings-detail');

        // Initialize settings UI from saved state
        function initSettings() {
            voiceEnabledToggle.checked = dmVoice.enabled;
            voiceSettingsDetail.style.display = dmVoice.enabled ? 'block' : 'none';

            // Set selected voice option
            document.querySelectorAll('.voice-option').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.voice === dmVoice.gender);
            });
        }

        document.getElementById('btn-settings').addEventListener('click', () => {
            initSettings();
            settingsModal.classList.add('visible');
        });

        document.getElementById('btn-close-settings').addEventListener('click', () => {
            settingsModal.classList.remove('visible');
        });

        // Voice enabled toggle
        voiceEnabledToggle.addEventListener('change', () => {
            dmVoice.enabled = voiceEnabledToggle.checked;
            localStorage.setItem('dmVoiceEnabled', dmVoice.enabled);
            voiceSettingsDetail.style.display = dmVoice.enabled ? 'block' : 'none';
        });

        // Voice gender selection
        document.querySelectorAll('.voice-option').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.voice-option').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                dmVoice.gender = btn.dataset.voice;
                localStorage.setItem('dmVoiceGender', dmVoice.gender);
            });
        });

        // Test voice button
        document.getElementById('btn-test-voice').addEventListener('click', testDMVoice);

        // ===== CHARACTER SHEET =====
        const charSheetModal = document.getElementById('char-sheet-modal');
        const itemPickerModal = document.getElementById('item-picker-modal');
        const spellPickerModal = document.getElementById('spell-picker-modal');
        let currentSheetCharId = null;
        let currentSheetCharClass = null;
        let currentSheetSpellSlots = null;
        let commonItems = [];
        let allSpells = [];
        let filteredSpells = [];
        let addingToPartyLoot = false;

        // Open character sheet
        async function openCharacterSheet(characterId) {
            currentSheetCharId = characterId;
            charSheetModal.classList.add('visible');
            await loadCharacterSheet();
            await loadPartyData();
        }

        // Load character data into sheet
        async function loadCharacterSheet() {
            if (!currentSheetCharId) return;

            try {
                // Load character data
                const charRes = await fetch(`/api/characters`);
                const charData = await charRes.json();
                const char = charData.characters.find(c => c.id == currentSheetCharId);
                if (!char) return;

                // Update header
                document.getElementById('sheet-char-name').textContent = char.name;

                // Stats
                const abilities = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
                abilities.forEach(ab => {
                    const val = char[ab] || 10;
                    const mod = Math.floor((val - 10) / 2);
                    document.getElementById(`sheet-${ab}`).textContent = val;
                    document.getElementById(`sheet-${ab}-mod`).textContent = mod >= 0 ? `+${mod}` : mod;
                });

                // Combat stats
                document.getElementById('sheet-hp').textContent = `${char.current_hp || char.max_hp}/${char.max_hp}`;
                document.getElementById('sheet-ac').textContent = char.ac || 10;
                const dexMod = Math.floor((char.dex - 10) / 2);
                document.getElementById('sheet-init').textContent = dexMod >= 0 ? `+${dexMod}` : dexMod;

                // Currency
                document.getElementById('sheet-pp').value = char.platinum || 0;
                document.getElementById('sheet-gp').value = char.gold || 0;
                document.getElementById('sheet-sp').value = char.silver || 0;
                document.getElementById('sheet-cp').value = char.copper || 0;

                // Store class and spell slots for spell filtering
                currentSheetCharClass = char.character_class;
                currentSheetSpellSlots = char.spell_slots || {};

                // Load inventory
                await loadInventory();

                // Load spells
                await loadSpells();

            } catch (e) {
                console.error('Failed to load character sheet:', e);
            }
        }

        // Load inventory
        async function loadInventory() {
            if (!currentSheetCharId) return;

            try {
                const res = await fetch(`/api/characters/${currentSheetCharId}/inventory`);
                const data = await res.json();

                const equipped = data.items.filter(i => i.equipped);
                const backpack = data.items.filter(i => !i.equipped);

                // Update weight
                document.getElementById('inv-weight').textContent = data.total_weight.toFixed(1);
                document.getElementById('inv-capacity').textContent = data.capacity;

                // Render equipped items
                const equippedList = document.getElementById('equipped-list');
                if (equipped.length === 0) {
                    equippedList.innerHTML = '<div class="inventory-empty">No items equipped</div>';
                } else {
                    equippedList.innerHTML = equipped.map(item => renderInventoryItem(item, true)).join('');
                }

                // Render backpack items
                const backpackList = document.getElementById('backpack-list');
                if (backpack.length === 0) {
                    backpackList.innerHTML = '<div class="inventory-empty">Backpack is empty</div>';
                } else {
                    backpackList.innerHTML = backpack.map(item => renderInventoryItem(item, false)).join('');
                }

                // Add event listeners
                document.querySelectorAll('.item-equip-btn').forEach(btn => {
                    btn.addEventListener('click', () => toggleEquip(btn.dataset.id, btn.dataset.equipped === 'true'));
                });
                document.querySelectorAll('.item-delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteItem(btn.dataset.id));
                });

            } catch (e) {
                console.error('Failed to load inventory:', e);
            }
        }

        function renderInventoryItem(item, equipped) {
            const icon = getItemIcon(item.slot || item.name);
            return `
                <div class="inventory-item ${equipped ? 'equipped' : ''}">
                    <span class="item-icon">${icon}</span>
                    <div class="item-info">
                        <span class="item-name">${escapeHtml(item.name)}</span>
                        <span class="item-meta">${item.quantity > 1 ? `x${item.quantity} ` : ''}${item.weight}lb</span>
                    </div>
                    <div class="item-actions">
                        <button class="item-equip-btn" data-id="${item.id}" data-equipped="${equipped}">
                            ${equipped ? 'Unequip' : 'Equip'}
                        </button>
                        <button class="item-delete-btn" data-id="${item.id}">&times;</button>
                    </div>
                </div>
            `;
        }

        function getItemIcon(type) {
            const icons = {
                'weapon': '&#x2694;', 'main_hand': '&#x2694;',
                'armor': '&#x1F6E1;', 'body': '&#x1F6E1;',
                'shield': '&#x1F6E1;', 'off_hand': '&#x1F6E1;',
                'potion': '&#x1F9EA;', 'scroll': '&#x1F4DC;',
                'wand': '&#x1FA84;', 'ring': '&#x1F48D;',
                'default': '&#x1F4E6;'
            };
            const lowerType = (type || '').toLowerCase();
            for (const [key, icon] of Object.entries(icons)) {
                if (lowerType.includes(key)) return icon;
            }
            return icons.default;
        }

        async function toggleEquip(itemId, currentlyEquipped) {
            try {
                await fetch(`/api/characters/${currentSheetCharId}/inventory/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ equipped: !currentlyEquipped })
                });
                await loadInventory();
            } catch (e) {
                console.error('Failed to toggle equip:', e);
            }
        }

        async function deleteItem(itemId) {
            if (!confirm('Remove this item?')) return;
            try {
                await fetch(`/api/characters/${currentSheetCharId}/inventory/${itemId}`, {
                    method: 'DELETE'
                });
                await loadInventory();
            } catch (e) {
                console.error('Failed to delete item:', e);
            }
        }

        // Load spells
        async function loadSpells() {
            if (!currentSheetCharId) return;

            try {
                const res = await fetch(`/api/characters/${currentSheetCharId}/spells`);
                const data = await res.json();

                // Render spell slots
                const slotsDisplay = document.getElementById('spell-slots-display');
                if (Object.keys(data.spell_slots).length === 0) {
                    slotsDisplay.innerHTML = '<div class="inventory-empty">No spell slots</div>';
                } else {
                    slotsDisplay.innerHTML = Object.entries(data.spell_slots).map(([level, slots]) => {
                        const ordinal = getOrdinal(parseInt(level));
                        const pips = Array(slots.total).fill(null).map((_, i) =>
                            `<span class="slot-pip ${i < slots.used ? 'used' : ''}"></span>`
                        ).join('');
                        return `
                            <div class="slot-level">
                                <span class="slot-label">${ordinal}</span>
                                <div class="slot-pips" data-level="${level}">${pips}</div>
                            </div>
                        `;
                    }).join('');
                }

                // Render known spells
                const spellList = document.getElementById('known-spells-list');
                if (data.spells_known.length === 0) {
                    spellList.innerHTML = '<div class="inventory-empty">No spells known</div>';
                } else {
                    spellList.innerHTML = data.spells_known.map(spell => `
                        <div class="spell-item">
                            <div class="spell-info">
                                <span class="spell-name">${escapeHtml(spell.name)}</span>
                                <span class="spell-meta">${spell.school} ${spell.level === 0 ? 'Cantrip' : `Lv${spell.level}`}</span>
                            </div>
                            ${spell.level > 0 ? `<button class="cast-btn" data-level="${spell.level}">Cast</button>` : ''}
                        </div>
                    `).join('');

                    // Add cast button listeners
                    document.querySelectorAll('.cast-btn').forEach(btn => {
                        btn.addEventListener('click', () => castSpell(parseInt(btn.dataset.level)));
                    });
                }

            } catch (e) {
                console.error('Failed to load spells:', e);
            }
        }

        function getOrdinal(n) {
            const suffixes = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return n + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
        }

        async function castSpell(level) {
            try {
                const res = await fetch(`/api/characters/${currentSheetCharId}/spells/cast`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level })
                });
                if (!res.ok) {
                    const err = await res.json();
                    alert(err.detail || 'Cannot cast spell');
                    return;
                }
                await loadSpells();
                updateQuickBarIndicators();
            } catch (e) {
                console.error('Failed to cast spell:', e);
            }
        }

        async function longRest() {
            try {
                await fetch(`/api/characters/${currentSheetCharId}/spells/rest`, {
                    method: 'POST'
                });
                await loadSpells();
                await loadCharacterSheet(); // Also refresh HP
                updateQuickBarIndicators();
                addSystemEntry('You take a long rest and recover.');
            } catch (e) {
                console.error('Failed to rest:', e);
            }
        }

        // Party data
        async function loadPartyData() {
            try {
                // Load treasury
                const treasuryRes = await fetch(`/api/party/treasury?session_code=${state.sessionCode}`);
                const treasuryData = await treasuryRes.json();
                document.getElementById('party-gold').textContent = treasuryData.gold;

                // Load loot
                const lootRes = await fetch(`/api/party/loot?session_code=${state.sessionCode}`);
                const lootData = await lootRes.json();

                const lootList = document.getElementById('party-loot-list');
                if (lootData.items.length === 0) {
                    lootList.innerHTML = '<div class="inventory-empty">No unclaimed loot</div>';
                } else {
                    lootList.innerHTML = lootData.items.map(item => `
                        <div class="loot-item">
                            <span class="item-icon">${getItemIcon(item.name)}</span>
                            <div class="item-info">
                                <span class="item-name">${escapeHtml(item.name)}</span>
                                <span class="item-meta">${item.quantity > 1 ? `x${item.quantity}` : ''}</span>
                            </div>
                            <button class="claim-btn" data-id="${item.id}">Claim</button>
                        </div>
                    `).join('');

                    document.querySelectorAll('.claim-btn').forEach(btn => {
                        btn.addEventListener('click', () => claimLoot(parseInt(btn.dataset.id)));
                    });
                }
            } catch (e) {
                console.error('Failed to load party data:', e);
            }
        }

        async function contributeGold() {
            const amount = parseInt(document.getElementById('treasury-amount').value) || 0;
            if (amount <= 0) return;

            try {
                // Subtract from character
                await fetch(`/api/characters/${currentSheetCharId}/currency`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gold: amount, operation: 'subtract' })
                });

                // Add to treasury
                await fetch(`/api/party/treasury?session_code=${state.sessionCode}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gold: amount, operation: 'add' })
                });

                await loadCharacterSheet();
                await loadPartyData();
                updateQuickBarIndicators();
            } catch (e) {
                console.error('Failed to contribute:', e);
            }
        }

        async function withdrawGold() {
            const amount = parseInt(document.getElementById('treasury-amount').value) || 0;
            if (amount <= 0) return;

            try {
                // Subtract from treasury
                await fetch(`/api/party/treasury?session_code=${state.sessionCode}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gold: amount, operation: 'subtract' })
                });

                // Add to character
                await fetch(`/api/characters/${currentSheetCharId}/currency`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gold: amount, operation: 'add' })
                });

                await loadCharacterSheet();
                await loadPartyData();
                updateQuickBarIndicators();
            } catch (e) {
                console.error('Failed to withdraw:', e);
            }
        }

        async function claimLoot(lootId) {
            try {
                await fetch(`/api/party/loot/claim?session_code=${state.sessionCode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ loot_id: lootId, character_id: currentSheetCharId })
                });
                await loadInventory();
                await loadPartyData();
            } catch (e) {
                console.error('Failed to claim loot:', e);
            }
        }

        // Item picker
        async function openItemPicker(forPartyLoot = false) {
            addingToPartyLoot = forPartyLoot;
            itemPickerModal.classList.add('visible');

            // Load common items if not loaded
            if (commonItems.length === 0) {
                try {
                    const res = await fetch('/api/items');
                    const data = await res.json();
                    commonItems = data.items;
                } catch (e) {
                    console.error('Failed to load items:', e);
                }
            }

            renderCommonItems();
        }

        function renderCommonItems(filter = '') {
            const list = document.getElementById('common-items-list');
            const filtered = commonItems.filter(item =>
                item.name.toLowerCase().includes(filter.toLowerCase())
            );

            list.innerHTML = filtered.map(item => `
                <div class="picker-item" data-name="${escapeHtml(item.name)}" data-weight="${item.weight}" data-value="${item.value}">
                    <span class="item-icon">${getItemIcon(item.category)}</span>
                    <div class="item-info">
                        <span class="item-name">${escapeHtml(item.name)}</span>
                        <span class="item-meta">${item.weight}lb, ${item.value}gp</span>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.picker-item').forEach(item => {
                item.addEventListener('click', () => addItemFromPicker(item));
            });
        }

        async function addItemFromPicker(itemEl) {
            const item = {
                name: itemEl.dataset.name,
                weight: parseFloat(itemEl.dataset.weight),
                value: parseInt(itemEl.dataset.value),
                quantity: 1
            };

            try {
                if (addingToPartyLoot) {
                    await fetch(`/api/party/loot?session_code=${state.sessionCode}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(item)
                    });
                    await loadPartyData();
                } else {
                    await fetch(`/api/characters/${currentSheetCharId}/inventory`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(item)
                    });
                    await loadInventory();
                }
                itemPickerModal.classList.remove('visible');
            } catch (e) {
                console.error('Failed to add item:', e);
            }
        }

        async function addCustomItem() {
            const name = document.getElementById('custom-item-name').value.trim();
            if (!name) return;

            const item = {
                name,
                quantity: parseInt(document.getElementById('custom-item-qty').value) || 1,
                weight: parseFloat(document.getElementById('custom-item-weight').value) || 1,
                value: parseInt(document.getElementById('custom-item-value').value) || 0
            };

            try {
                if (addingToPartyLoot) {
                    await fetch(`/api/party/loot?session_code=${state.sessionCode}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(item)
                    });
                    await loadPartyData();
                } else {
                    await fetch(`/api/characters/${currentSheetCharId}/inventory`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(item)
                    });
                    await loadInventory();
                }
                itemPickerModal.classList.remove('visible');
                document.getElementById('custom-item-name').value = '';
            } catch (e) {
                console.error('Failed to add custom item:', e);
            }
        }

        // Spell picker
        async function openSpellPicker() {
            spellPickerModal.classList.add('visible');

            // Calculate max spell level based on spell slots
            let maxLevel = 0;
            if (currentSheetSpellSlots) {
                for (const level of Object.keys(currentSheetSpellSlots)) {
                    const lvl = parseInt(level);
                    if (lvl > maxLevel) maxLevel = lvl;
                }
            }

            // Fetch spells filtered by class and max level
            try {
                let url = '/api/spells';
                if (currentSheetCharClass) {
                    url += `?character_class=${encodeURIComponent(currentSheetCharClass)}&max_level=${maxLevel}`;
                }
                const res = await fetch(url);
                const data = await res.json();
                filteredSpells = data.spells;
            } catch (e) {
                console.error('Failed to load spells:', e);
            }

            renderSpellPicker();
        }

        function renderSpellPicker(filter = '', levelFilter = '') {
            const list = document.getElementById('spell-picker-list');
            const filtered = filteredSpells.filter(spell => {
                const matchesName = spell.name.toLowerCase().includes(filter.toLowerCase());
                const matchesLevel = levelFilter === '' || spell.level === parseInt(levelFilter);
                return matchesName && matchesLevel;
            });

            list.innerHTML = filtered.map(spell => `
                <div class="picker-item spell-picker-item" data-name="${escapeHtml(spell.name)}">
                    <div class="spell-info">
                        <span class="spell-name">${escapeHtml(spell.name)}</span>
                        <span class="spell-meta">${spell.school} ${spell.level === 0 ? 'Cantrip' : `Lv${spell.level}`}</span>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.spell-picker-item').forEach(item => {
                item.addEventListener('click', () => learnSpell(item.dataset.name));
            });
        }

        async function learnSpell(spellName) {
            try {
                const res = await fetch(`/api/characters/${currentSheetCharId}/spells/learn`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ spell_name: spellName })
                });
                if (!res.ok) {
                    const err = await res.json();
                    alert(err.detail || 'Failed to learn spell');
                    return;
                }
                await loadSpells();
                spellPickerModal.classList.remove('visible');
            } catch (e) {
                console.error('Failed to learn spell:', e);
                alert('Failed to learn spell');
            }
        }

        // Save currency
        async function saveCurrency() {
            try {
                await fetch(`/api/characters/${currentSheetCharId}/currency`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platinum: parseInt(document.getElementById('sheet-pp').value) || 0,
                        gold: parseInt(document.getElementById('sheet-gp').value) || 0,
                        silver: parseInt(document.getElementById('sheet-sp').value) || 0,
                        copper: parseInt(document.getElementById('sheet-cp').value) || 0,
                        operation: 'set'
                    })
                });
                updateQuickBarIndicators();
            } catch (e) {
                console.error('Failed to save currency:', e);
            }
        }

        // Character sheet tab switching
        document.querySelectorAll('.sheet-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.sheet-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.sheet-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
            });
        });

        // Item picker tab switching
        document.querySelectorAll('.picker-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.picker-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.picker-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`picker-${tab.dataset.picker}`).classList.add('active');
            });
        });

        // Event listeners for character sheet
        document.getElementById('btn-close-sheet').addEventListener('click', () => {
            charSheetModal.classList.remove('visible');
        });

        document.getElementById('btn-save-currency').addEventListener('click', saveCurrency);
        document.getElementById('btn-add-item').addEventListener('click', () => openItemPicker(false));
        document.getElementById('btn-add-loot').addEventListener('click', () => openItemPicker(true));
        document.getElementById('btn-learn-spell').addEventListener('click', openSpellPicker);
        document.getElementById('btn-long-rest').addEventListener('click', longRest);
        document.getElementById('btn-contribute').addEventListener('click', contributeGold);
        document.getElementById('btn-withdraw').addEventListener('click', withdrawGold);

        // Item picker events
        document.getElementById('btn-close-picker').addEventListener('click', () => {
            itemPickerModal.classList.remove('visible');
        });
        document.getElementById('item-search').addEventListener('input', (e) => {
            renderCommonItems(e.target.value);
        });
        document.getElementById('btn-add-custom-item').addEventListener('click', addCustomItem);

        // Spell picker events
        document.getElementById('btn-close-spell-picker').addEventListener('click', () => {
            spellPickerModal.classList.remove('visible');
        });
        document.getElementById('spell-search').addEventListener('input', (e) => {
            renderSpellPicker(e.target.value, document.getElementById('spell-level-filter').value);
        });
        document.getElementById('spell-level-filter').addEventListener('change', (e) => {
            renderSpellPicker(document.getElementById('spell-search').value, e.target.value);
        });

        // Character sheet button in header
        document.getElementById('btn-char-sheet').addEventListener('click', () => {
            if (state.selectedCharacter && state.selectedCharacter.id) {
                openCharacterSheet(state.selectedCharacter.id);
            }
        });

        // Quick gold indicator click opens character sheet
        document.getElementById('quick-gold').addEventListener('click', () => {
            if (state.selectedCharacter && state.selectedCharacter.id) {
                openCharacterSheet(state.selectedCharacter.id);
                // Switch to stats tab (currency)
                document.querySelector('.sheet-tab[data-tab="stats"]').click();
            }
        });

        // Quick spell slots indicator click opens character sheet
        document.getElementById('quick-slots').addEventListener('click', () => {
            if (state.selectedCharacter && state.selectedCharacter.id) {
                openCharacterSheet(state.selectedCharacter.id);
                // Switch to spells tab
                document.querySelector('.sheet-tab[data-tab="spells"]').click();
            }
        });

        // Update quick bar indicators
        async function updateQuickBarIndicators() {
            if (!state.selectedCharacter || !state.selectedCharacter.id) return;

            try {
                // Get character data for gold
                const charRes = await fetch('/api/characters');
                const charData = await charRes.json();
                const char = charData.characters.find(c => c.id == state.selectedCharacter.id);
                if (char) {
                    const totalGold = (char.platinum || 0) * 10 + (char.gold || 0) + (char.silver || 0) / 10 + (char.copper || 0) / 100;
                    document.getElementById('quick-gold-val').textContent = Math.floor(totalGold);
                }

                // Get spell slots
                const spellRes = await fetch(`/api/characters/${state.selectedCharacter.id}/spells`);
                const spellData = await spellRes.json();
                const slots = spellData.spell_slots;
                if (Object.keys(slots).length > 0) {
                    let totalUsed = 0;
                    let totalSlots = 0;
                    Object.values(slots).forEach(s => {
                        totalUsed += s.used;
                        totalSlots += s.total;
                    });
                    const remaining = totalSlots - totalUsed;
                    document.getElementById('quick-slots-val').textContent = `${remaining}/${totalSlots}`;
                } else {
                    document.getElementById('quick-slots-val').textContent = '-';
                }
            } catch (e) {
                console.error('Failed to update quick bar:', e);
            }
        }

        // Initialize
        checkStatus();
        setInterval(checkStatus, 30000);
    </script>
</body>
</html>
