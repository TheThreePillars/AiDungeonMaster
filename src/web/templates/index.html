<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Dungeon Master - Pathfinder 1e</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-surface: #161b22;
            --bg-elevated: #21262d;
            --bg-hover: #30363d;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-gold: #d4a017;
            --accent-purple: #8b5cf6;
            --accent-blue: #58a6ff;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --hp-high: #3fb950;
            --hp-mid: #d29922;
            --hp-low: #f85149;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport height for mobile */
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* ===== TITLE SCREEN ===== */
        #title-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            min-height: 100dvh;
            padding: 1rem;
            background: linear-gradient(180deg, var(--bg-dark) 0%, #1a1a2e 100%);
            overflow-y: auto;
        }

        .title-card {
            background: var(--bg-surface);
            border: 2px solid var(--accent-gold);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 0 40px rgba(212, 160, 23, 0.2);
        }

        @media (min-width: 480px) {
            #title-screen {
                padding: 2rem;
            }
            .title-card {
                padding: 2.5rem;
            }
        }

        .game-icon {
            font-size: 3rem;
            margin-bottom: 0.75rem;
        }

        @media (min-width: 480px) {
            .game-icon {
                font-size: 4rem;
                margin-bottom: 1rem;
            }
        }

        .game-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 0.25rem;
            text-shadow: 0 0 20px rgba(212, 160, 23, 0.5);
        }

        @media (min-width: 480px) {
            .game-title {
                font-size: 1.75rem;
                margin-bottom: 0.5rem;
            }
        }

        .game-subtitle {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }

        @media (min-width: 480px) {
            .game-subtitle {
                margin-bottom: 2rem;
                font-size: 1rem;
            }
        }

        .menu-btn {
            display: block;
            width: 100%;
            padding: 0.875rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            min-height: 44px; /* Touch-friendly target */
        }

        @media (min-width: 480px) {
            .menu-btn {
                padding: 1rem;
                margin-bottom: 0.75rem;
                font-size: 1rem;
            }
        }

        .menu-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-gold);
        }

        .menu-btn.primary {
            background: linear-gradient(135deg, #2d5a27 0%, #1e3a1a 100%);
            border-color: var(--success);
        }

        .menu-btn.primary:hover {
            background: linear-gradient(135deg, #3d7a37 0%, #2e5a2a 100%);
        }

        .menu-divider {
            height: 1px;
            background: var(--border);
            margin: 1rem 0;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.offline {
            background: var(--danger);
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: flex-start;
            justify-content: center;
            padding: 0.5rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (min-width: 480px) {
            .modal-overlay {
                align-items: center;
                padding: 1rem;
            }
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            max-width: 360px;
            width: 100%;
            margin: 0.5rem 0;
            max-height: calc(100vh - 1rem);
            max-height: calc(100dvh - 1rem);
            overflow-y: auto;
        }

        @media (min-width: 480px) {
            .modal-card {
                padding: 1.5rem;
                border-radius: 1rem;
                margin: 1rem 0;
                max-height: calc(100vh - 2rem);
                max-height: calc(100dvh - 2rem);
            }
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        @media (min-width: 480px) {
            .modal-title {
                font-size: 1.25rem;
                margin-bottom: 1.5rem;
            }
        }

        .form-group {
            margin-bottom: 1rem;
        }

        @media (min-width: 480px) {
            .form-group {
                margin-bottom: 1.5rem;
            }
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.375rem;
        }

        @media (min-width: 480px) {
            .form-label {
                font-size: 0.875rem;
                margin-bottom: 0.5rem;
            }
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 16px; /* Prevents iOS zoom */
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* ===== GAME SCREEN ===== */
        #game-screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }

        /* Header */
        .game-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        @media (min-width: 480px) {
            .game-header {
                padding: 0.75rem 1rem;
                gap: 0.75rem;
            }
        }

        .location-info {
            flex: 1;
            min-width: 0; /* Allow text truncation */
        }

        .location-name {
            font-weight: 600;
            color: var(--accent-gold);
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (min-width: 480px) {
            .location-name {
                font-size: 1rem;
            }
        }

        .location-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .header-status {
            display: none; /* Hidden on mobile */
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        @media (min-width: 480px) {
            .header-status {
                display: flex;
            }
        }

        .header-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            padding: 0.375rem 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            min-width: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 480px) {
            .header-btn {
                padding: 0.5rem 0.75rem;
                border-radius: 0.5rem;
            }
        }

        /* Main Layout */
        .game-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 100;
                width: 85%;
                max-width: 320px;
            }

            .sidebar.visible {
                display: flex;
            }
        }

        .sidebar-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        /* Party Members */
        .party-member {
            background: var(--bg-elevated);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .member-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .member-class {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .hp-bar-container {
            background: var(--bg-dark);
            border-radius: 0.25rem;
            height: 8px;
            overflow: hidden;
        }

        .hp-bar {
            height: 100%;
            background: var(--hp-high);
            transition: width 0.3s, background 0.3s;
        }

        .hp-bar.mid { background: var(--hp-mid); }
        .hp-bar.low { background: var(--hp-low); }

        .hp-text {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-purple);
        }

        .action-btn.combat {
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Narrative Area */
        .narrative-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0; /* Important for flexbox overflow */
        }

        .narrative-log {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            background: var(--bg-dark);
            -webkit-overflow-scrolling: touch;
        }

        @media (min-width: 480px) {
            .narrative-log {
                padding: 1rem;
            }
        }

        .narrative-entry {
            margin-bottom: 0.75rem;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        @media (min-width: 480px) {
            .narrative-entry {
                margin-bottom: 1rem;
                line-height: 1.6;
                font-size: 1rem;
            }
        }

        .entry-dm {
            padding: 0.75rem;
            background: var(--bg-surface);
            border-left: 3px solid var(--accent-purple);
            border-radius: 0 0.5rem 0.5rem 0;
        }

        @media (min-width: 480px) {
            .entry-dm {
                padding: 1rem;
            }
        }

        .entry-player {
            padding: 0.625rem 0.75rem;
            background: var(--bg-elevated);
            border-left: 3px solid var(--accent-blue);
            border-radius: 0 0.5rem 0.5rem 0;
        }

        @media (min-width: 480px) {
            .entry-player {
                padding: 0.75rem 1rem;
            }
        }

        .entry-header {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.375rem;
        }

        @media (min-width: 480px) {
            .entry-header {
                font-size: 0.75rem;
                margin-bottom: 0.5rem;
            }
        }

        .entry-dm .entry-header {
            color: var(--accent-purple);
        }

        .entry-player .entry-header {
            color: var(--accent-blue);
        }

        .entry-system {
            text-align: center;
            padding: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .entry-dice {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--accent-gold);
            border-radius: 2rem;
            font-size: 0.875rem;
        }

        .dice-result {
            font-weight: bold;
            color: var(--accent-gold);
        }

        .typing-indicator {
            display: none;
            padding: 1rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .typing-indicator.visible {
            display: block;
        }

        /* Input Area */
        .input-area {
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
            padding: 0.5rem;
            flex-shrink: 0;
        }

        @media (min-width: 480px) {
            .input-area {
                padding: 0.75rem 1rem;
            }
        }

        .input-row {
            display: flex;
            gap: 0.375rem;
        }

        @media (min-width: 480px) {
            .input-row {
                gap: 0.5rem;
            }
        }

        .action-input {
            flex: 1;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 16px; /* Prevents iOS zoom */
            resize: none;
            min-height: 40px;
        }

        @media (min-width: 480px) {
            .action-input {
                padding: 0.75rem 1rem;
            }
        }

        .action-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .input-btn {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 1.125rem;
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        @media (min-width: 480px) {
            .input-btn {
                padding: 0.75rem;
                font-size: 1.25rem;
                min-width: 48px;
            }
        }

        .input-btn:hover {
            background: var(--bg-hover);
        }

        .input-btn.recording {
            background: var(--danger);
            border-color: var(--danger);
            animation: pulse 1s infinite;
        }

        .input-btn.listening {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            animation: pulse-listen 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes pulse-listen {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Bottom Quick Bar */
        .quick-bar {
            display: flex;
            gap: 0.375rem;
            padding: 0.375rem 0.5rem;
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
            overflow-x: auto;
            flex-shrink: 0;
            -webkit-overflow-scrolling: touch;
        }

        @media (min-width: 480px) {
            .quick-bar {
                gap: 0.5rem;
                padding: 0.5rem 1rem;
            }
        }

        .quick-chip {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 2rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.8rem;
            white-space: nowrap;
            cursor: pointer;
            min-height: 32px;
        }

        @media (min-width: 480px) {
            .quick-chip {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
        }

        .quick-chip:hover {
            border-color: var(--accent-gold);
        }

        /* Dice Panel */
        .dice-panel {
            display: none;
            padding: 1rem;
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
        }

        .dice-panel.visible {
            display: block;
        }

        .dice-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
        }

        @media (max-width: 480px) {
            .dice-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .dice-btn {
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .dice-btn:hover {
            border-color: var(--accent-gold);
            background: rgba(212, 160, 23, 0.1);
        }

        /* Right Panel - NPCs */
        .right-panel {
            width: 240px;
            background: var(--bg-surface);
            border-left: 1px solid var(--border);
            padding: 1rem;
            overflow-y: auto;
        }

        @media (max-width: 1024px) {
            .right-panel {
                display: none;
            }
        }

        .npc-item {
            background: var(--bg-elevated);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .npc-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .npc-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Players list */
        .players-list {
            padding: 0;
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-elevated);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .player-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .player-name {
            font-size: 0.875rem;
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .sidebar-overlay.visible {
            display: block;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        /* Character Screen */
        #character-screen {
            min-height: 100vh;
            background: var(--bg-dark);
            padding: 1rem;
        }

        .char-screen-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .char-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .char-header h2 {
            flex: 1;
            color: var(--accent-gold);
        }

        .char-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .char-loading {
            text-align: center;
            color: var(--text-muted);
            padding: 2rem;
        }

        .char-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .char-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .char-details {
            flex: 1;
        }

        .char-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .char-meta {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .char-hp {
            font-size: 0.75rem;
            color: var(--hp-high);
        }

        .char-delete {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .char-delete:hover {
            background: var(--danger);
            color: white;
        }

        .empty-chars {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        /* Option Grid for Race/Class selection */
        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .option-btn {
            padding: 0.625rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .option-btn:hover {
            border-color: var(--accent-gold);
        }

        .option-btn.selected {
            border-color: var(--accent-gold);
            background: rgba(212, 160, 23, 0.2);
            color: var(--accent-gold);
        }

        .race-info, .class-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 0.5rem;
            background: var(--bg-dark);
            border-radius: 0.375rem;
            min-height: 2.5rem;
        }

        /* Ability Scores */
        .ability-grid {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .ability-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-elevated);
            border-radius: 0.5rem;
        }

        .ability-name {
            width: 40px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .ability-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ability-btn:hover {
            border-color: var(--accent-gold);
        }

        .ability-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ability-value {
            width: 36px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .ability-mod {
            width: 36px;
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Session Code */
        .session-code-display {
            text-align: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-dark);
            border-radius: 0.5rem;
        }

        @media (min-width: 480px) {
            .session-code-display {
                margin-bottom: 1.5rem;
                padding: 1rem;
            }
        }

        .session-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.375rem;
        }

        @media (min-width: 480px) {
            .session-label {
                font-size: 0.875rem;
                margin-bottom: 0.5rem;
            }
        }

        .session-code {
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 0.4rem;
            color: var(--accent-gold);
            font-family: monospace;
        }

        @media (min-width: 480px) {
            .session-code {
                font-size: 2.5rem;
                letter-spacing: 0.5rem;
            }
        }

        .session-input {
            text-transform: uppercase;
            text-align: center;
            font-size: 1.25rem;
            letter-spacing: 0.25rem;
            font-family: monospace;
        }

        @media (min-width: 480px) {
            .session-input {
                font-size: 1.5rem;
                letter-spacing: 0.3rem;
            }
        }

        .header-session-code {
            font-family: monospace;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-gold);
            background: var(--bg-dark);
            padding: 0.25rem 0.375rem;
            border-radius: 0.25rem;
            letter-spacing: 0.1rem;
        }

        @media (min-width: 480px) {
            .header-session-code {
                font-size: 0.875rem;
                padding: 0.25rem 0.5rem;
            }
        }

        .copy-btn {
            margin-top: 0.5rem;
            padding: 0.5rem 1.25rem;
            border: 1px solid var(--accent-gold);
            border-radius: 0.5rem;
            background: transparent;
            color: var(--accent-gold);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        @media (min-width: 480px) {
            .copy-btn {
                margin-top: 0.75rem;
                padding: 0.5rem 1.5rem;
                font-size: 0.875rem;
            }
        }

        .copy-btn:hover {
            background: var(--accent-gold);
            color: var(--bg-dark);
        }

        .copy-btn.copied {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        /* Character Selection in Modals */
        .char-select-list {
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .char-select-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .char-select-item:hover {
            border-color: var(--accent-gold);
        }

        .char-select-item.selected {
            border-color: var(--accent-gold);
            background: rgba(212, 160, 23, 0.1);
        }

        .char-select-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .char-select-info {
            flex: 1;
        }

        .char-select-name {
            font-weight: 600;
        }

        .char-select-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .char-select-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-muted);
        }

        .char-select-empty a {
            color: var(--accent-gold);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Title Screen -->
    <div id="title-screen">
        <div class="title-card">
            <div class="game-icon">&#x1F3B2;</div>
            <h1 class="game-title">AI Dungeon Master</h1>
            <p class="game-subtitle">Pathfinder 1st Edition</p>

            <button class="menu-btn primary" id="btn-new-game">&#x25B6; New Game</button>
            <button class="menu-btn" id="btn-join-game">&#x1F517; Join Game</button>

            <div class="menu-divider"></div>

            <button class="menu-btn" id="btn-characters">&#x1F9D9; Manage Characters</button>
            <button class="menu-btn" id="btn-bestiary">&#x1F432; Bestiary</button>
            <button class="menu-btn" id="btn-settings">&#x2699; Settings</button>

            <div class="status-bar">
                <div class="status-item">
                    <span class="status-dot" id="ai-status-dot"></span>
                    <span id="ai-status-text">Checking AI...</span>
                </div>
                <div class="status-item">
                    <span id="version-text">v0.2.0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- New Game Modal (shows session code) -->
    <div class="modal-overlay" id="new-game-modal">
        <div class="modal-card" style="max-width: 450px;">
            <h2 class="modal-title">New Game Created!</h2>
            <div class="session-code-display">
                <div class="session-label">Share this code with your party:</div>
                <div class="session-code" id="new-session-code">----</div>
                <button class="copy-btn" id="btn-copy-code">Copy Code</button>
            </div>
            <div class="form-group">
                <label class="form-label">Select Character</label>
                <div class="char-select-list" id="new-game-char-list">
                    <div class="char-loading">Loading characters...</div>
                </div>
            </div>
            <button class="menu-btn primary" id="btn-start-new">Start Game</button>
            <button class="menu-btn" id="btn-cancel-new">Cancel</button>
        </div>
    </div>

    <!-- Join Game Modal -->
    <div class="modal-overlay" id="join-game-modal">
        <div class="modal-card" style="max-width: 450px;">
            <h2 class="modal-title">Join Game</h2>
            <div class="form-group">
                <label class="form-label" for="join-code">Session Code</label>
                <input type="text" id="join-code" class="form-input session-input" placeholder="ABCD" maxlength="4" autocomplete="off">
            </div>
            <div class="form-group">
                <label class="form-label">Select Character</label>
                <div class="char-select-list" id="join-game-char-list">
                    <div class="char-loading">Loading characters...</div>
                </div>
            </div>
            <button class="menu-btn primary" id="btn-join-session">Join Game</button>
            <button class="menu-btn" id="btn-cancel-join">Cancel</button>
        </div>
    </div>

    <!-- Character Management Screen -->
    <div id="character-screen" style="display: none;">
        <div class="char-screen-container">
            <div class="char-header">
                <button class="header-btn" id="btn-back-to-menu">&#x2190;</button>
                <h2>Manage Characters</h2>
                <button class="menu-btn primary" id="btn-create-new" style="padding: 0.5rem 1rem; width: auto;">+ New</button>
            </div>

            <!-- Character List -->
            <div class="char-list" id="character-list">
                <div class="char-loading">Loading characters...</div>
            </div>
        </div>
    </div>

    <!-- Character Creation Modal -->
    <div class="modal-overlay" id="create-char-modal">
        <div class="modal-card" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <h2 class="modal-title">Create Character</h2>

            <!-- Step 1: Name -->
            <div class="form-group">
                <label class="form-label">Character Name</label>
                <input type="text" id="char-name" class="form-input" placeholder="Enter name...">
            </div>

            <!-- Step 2: Race -->
            <div class="form-group">
                <label class="form-label">Race</label>
                <div class="option-grid" id="race-options"></div>
                <div class="race-info" id="race-info"></div>
            </div>

            <!-- Step 3: Class -->
            <div class="form-group">
                <label class="form-label">Class</label>
                <div class="option-grid" id="class-options"></div>
                <div class="class-info" id="class-info"></div>
            </div>

            <!-- Step 4: Ability Scores -->
            <div class="form-group">
                <label class="form-label">Ability Scores <span style="color: var(--text-muted);">(Points: <span id="points-remaining">20</span>)</span></label>
                <div class="ability-grid">
                    <div class="ability-row">
                        <span class="ability-name">STR</span>
                        <button class="ability-btn" data-ability="strength" data-dir="-">-</button>
                        <span class="ability-value" id="str-value">10</span>
                        <button class="ability-btn" data-ability="strength" data-dir="+">+</button>
                        <span class="ability-mod" id="str-mod">+0</span>
                    </div>
                    <div class="ability-row">
                        <span class="ability-name">DEX</span>
                        <button class="ability-btn" data-ability="dexterity" data-dir="-">-</button>
                        <span class="ability-value" id="dex-value">10</span>
                        <button class="ability-btn" data-ability="dexterity" data-dir="+">+</button>
                        <span class="ability-mod" id="dex-mod">+0</span>
                    </div>
                    <div class="ability-row">
                        <span class="ability-name">CON</span>
                        <button class="ability-btn" data-ability="constitution" data-dir="-">-</button>
                        <span class="ability-value" id="con-value">10</span>
                        <button class="ability-btn" data-ability="constitution" data-dir="+">+</button>
                        <span class="ability-mod" id="con-mod">+0</span>
                    </div>
                    <div class="ability-row">
                        <span class="ability-name">INT</span>
                        <button class="ability-btn" data-ability="intelligence" data-dir="-">-</button>
                        <span class="ability-value" id="int-value">10</span>
                        <button class="ability-btn" data-ability="intelligence" data-dir="+">+</button>
                        <span class="ability-mod" id="int-mod">+0</span>
                    </div>
                    <div class="ability-row">
                        <span class="ability-name">WIS</span>
                        <button class="ability-btn" data-ability="wisdom" data-dir="-">-</button>
                        <span class="ability-value" id="wis-value">10</span>
                        <button class="ability-btn" data-ability="wisdom" data-dir="+">+</button>
                        <span class="ability-mod" id="wis-mod">+0</span>
                    </div>
                    <div class="ability-row">
                        <span class="ability-name">CHA</span>
                        <button class="ability-btn" data-ability="charisma" data-dir="-">-</button>
                        <span class="ability-value" id="cha-value">10</span>
                        <button class="ability-btn" data-ability="charisma" data-dir="+">+</button>
                        <span class="ability-mod" id="cha-mod">+0</span>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button class="menu-btn" id="btn-cancel-create" style="flex: 1;">Cancel</button>
                <button class="menu-btn primary" id="btn-save-char" style="flex: 1;">Create Character</button>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen">
        <!-- Header -->
        <header class="game-header">
            <button class="header-btn" id="btn-menu">&#x2630;</button>
            <span class="header-session-code" id="header-session-code">----</span>
            <div class="location-info">
                <div class="location-name" id="location-name">The Rusty Dragon Inn</div>
                <div class="location-time" id="location-time">Evening</div>
            </div>
            <div class="header-status">
                <span class="status-dot" id="game-status-dot"></span>
                <span id="game-status-text">AI Online</span>
            </div>
            <button class="header-btn" id="btn-players">&#x1F465;</button>
        </header>

        <!-- Main Content -->
        <div class="game-main">
            <!-- Left Sidebar -->
            <aside class="sidebar" id="sidebar">
                <!-- Party Section -->
                <div class="sidebar-section">
                    <div class="section-title">&#x2694; Party</div>
                    <div id="party-list">
                        <div class="party-member">
                            <div class="member-header">
                                <span class="member-name">No Characters</span>
                            </div>
                            <div class="member-class">Create a character to begin</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="sidebar-section">
                    <div class="section-title">&#x26A1; Quick Actions</div>
                    <div class="quick-actions">
                        <button class="action-btn" data-action="I look around carefully, examining my surroundings.">&#x1F441; Look Around</button>
                        <button class="action-btn" data-action="I take a short rest to recover.">&#x1F4A4; Rest</button>
                        <button class="action-btn" data-action="I check my inventory and equipment.">&#x1F392; Inventory</button>
                        <button class="action-btn" data-action="I search the area for hidden items or secrets.">&#x1F50D; Search</button>
                        <button class="action-btn combat" data-action="I draw my weapon and prepare for combat!">&#x2694; Combat</button>
                    </div>
                </div>

                <!-- Players Online -->
                <div class="sidebar-section">
                    <div class="section-title">&#x1F465; Players Online</div>
                    <div class="players-list" id="players-list">
                        <div class="player-item">
                            <span style="color: var(--text-muted); font-size: 0.875rem;">No players connected</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Sidebar Overlay (mobile) -->
            <div class="sidebar-overlay" id="sidebar-overlay"></div>

            <!-- Narrative Area -->
            <main class="narrative-area">
                <div class="narrative-log" id="narrative-log">
                    <div class="narrative-entry entry-dm">
                        <div class="entry-header">&#x1F3AD; Dungeon Master</div>
                        <div class="entry-content">
                            <strong>Welcome, adventurer!</strong><br><br>
                            You find yourself in the common room of the Rusty Dragon Inn. The smell of roasting meat and fresh bread fills the air. Patrons laugh and chat at nearby tables while a bard strums a lute in the corner.<br><br>
                            <em>What would you like to do?</em>
                        </div>
                    </div>
                    <div class="typing-indicator" id="typing-indicator">
                        &#x1F3AD; The Dungeon Master is thinking...
                    </div>
                </div>

                <!-- Dice Panel -->
                <div class="dice-panel" id="dice-panel">
                    <div class="dice-grid">
                        <button class="dice-btn" data-dice="1d4">d4</button>
                        <button class="dice-btn" data-dice="1d6">d6</button>
                        <button class="dice-btn" data-dice="1d8">d8</button>
                        <button class="dice-btn" data-dice="1d10">d10</button>
                        <button class="dice-btn" data-dice="1d12">d12</button>
                        <button class="dice-btn" data-dice="1d20">d20</button>
                    </div>
                </div>

                <!-- Quick Bar -->
                <div class="quick-bar">
                    <button class="quick-chip" id="btn-dice-toggle">&#x1F3B2; Roll Dice</button>
                    <button class="quick-chip" data-action="I talk to the bartender.">&#x1F5E3; Talk</button>
                    <button class="quick-chip" data-action="I order a drink.">&#x1F37A; Drink</button>
                    <button class="quick-chip" data-action="I listen for rumors.">&#x1F442; Listen</button>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-row">
                        <textarea class="action-input" id="action-input" rows="1" placeholder="What do you do?"></textarea>
                        <button class="input-btn" id="voice-btn" title="Hold to speak">&#x1F3A4;</button>
                        <button class="input-btn" id="send-btn">&#x27A4;</button>
                    </div>
                </div>
            </main>

            <!-- Right Panel - NPCs -->
            <aside class="right-panel">
                <div class="section-title">&#x1F9D1; NPCs Nearby</div>
                <div id="npc-list">
                    <div class="npc-item">
                        <div class="npc-name">Ameiko Kaijitsu</div>
                        <div class="npc-desc">Innkeeper, standing behind the bar</div>
                    </div>
                    <div class="npc-item">
                        <div class="npc-name">Traveling Merchant</div>
                        <div class="npc-desc">Sitting alone, counting coins</div>
                    </div>
                    <div class="npc-item">
                        <div class="npc-name">Local Bard</div>
                        <div class="npc-desc">Playing a lute in the corner</div>
                    </div>
                </div>

                <div class="section-title" style="margin-top: 1.5rem;">&#x1F4DC; Active Quests</div>
                <div id="quest-list">
                    <div class="npc-item">
                        <div class="npc-name">A New Beginning</div>
                        <div class="npc-desc">Find adventure in Sandpoint</div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // State
        const state = {
            playerName: '',
            sessionCode: '',
            selectedCharacter: null,
            ws: null,
            connected: false,
            // Voice recording with VAD
            recording: false,
            listening: false, // Waiting for speech
            mediaRecorder: null,
            audioChunks: [],
            audioContext: null,
            analyser: null,
            audioStream: null,
            silenceTimer: null,
            speechDetected: false,
            aiAvailable: false,
            speechAvailable: false,
        };

        // Voice Activity Detection settings
        const VAD_CONFIG = {
            silenceThreshold: 15,      // Audio level below this = silence (0-128)
            silenceDuration: 1500,      // ms of silence before auto-submit
            minSpeechDuration: 300,     // Minimum ms of speech before considering it valid
        };

        // Elements
        const titleScreen = document.getElementById('title-screen');
        const gameScreen = document.getElementById('game-screen');
        const newGameModal = document.getElementById('new-game-modal');
        const joinGameModal = document.getElementById('join-game-modal');
        const narrativeLog = document.getElementById('narrative-log');
        const actionInput = document.getElementById('action-input');
        const typingIndicator = document.getElementById('typing-indicator');
        const dicePanel = document.getElementById('dice-panel');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        // Check server status
        async function checkStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                state.aiAvailable = data.ai_available;
                state.speechAvailable = data.speech_available;

                // Update title screen status
                const dot = document.getElementById('ai-status-dot');
                const text = document.getElementById('ai-status-text');
                dot.classList.toggle('offline', !data.ai_available);
                text.textContent = data.ai_available ? 'AI Online' : 'AI Offline';

                // Update game screen status
                const gameDot = document.getElementById('game-status-dot');
                const gameText = document.getElementById('game-status-text');
                if (gameDot) {
                    gameDot.classList.toggle('offline', !data.ai_available);
                    gameText.textContent = data.ai_available ? 'AI Online' : 'AI Offline';
                }

                // Voice button
                const voiceBtn = document.getElementById('voice-btn');
                voiceBtn.style.opacity = data.speech_available ? '1' : '0.5';
                voiceBtn.title = data.speech_available ? 'Tap to speak' : 'Voice unavailable';
            } catch (e) {
                document.getElementById('ai-status-dot').classList.add('offline');
                document.getElementById('ai-status-text').textContent = 'Server Offline';
            }
        }

        // Connect WebSocket
        function connect() {
            // Use wss:// for HTTPS, ws:// for HTTP
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/${state.sessionCode}/${state.playerName}`;
            state.ws = new WebSocket(wsUrl);

            state.ws.onopen = () => {
                state.connected = true;
                console.log('Connected to server');
            };

            state.ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };

            state.ws.onclose = () => {
                state.connected = false;
                console.log('Disconnected');
                setTimeout(connect, 3000);
            };

            state.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Handle incoming messages
        function handleMessage(data) {
            switch (data.type) {
                case 'connected':
                    document.getElementById('location-name').textContent = data.location || 'Unknown Location';
                    if (data.session_code) {
                        document.getElementById('header-session-code').textContent = data.session_code;
                    }
                    break;

                case 'player_joined':
                    addSystemEntry(`${data.player_name} joined the adventure`);
                    updatePlayersList(data.players || []);
                    break;

                case 'player_left':
                    addSystemEntry(`${data.player_name} left the game`);
                    updatePlayersList(data.players || []);
                    break;

                case 'player_action':
                    if (data.player !== state.playerName) {
                        addPlayerEntry(data.player, data.action);
                    }
                    break;

                case 'dm_typing':
                    typingIndicator.classList.toggle('visible', data.status);
                    scrollToBottom();
                    break;

                case 'dm_response_stream':
                    updateStreamingEntry(data.token);
                    break;

                case 'dm_response':
                    typingIndicator.classList.remove('visible');
                    finalizeStreamingEntry(data.content);
                    break;

                case 'dice_roll':
                    addDiceEntry(data.player, data.notation, data.result, data.rolls);
                    break;

                case 'chat':
                    addPlayerEntry(data.player, data.content);
                    break;

                case 'error':
                    addSystemEntry(`Error: ${data.message}`);
                    break;
            }
        }

        // Narrative entries
        let streamingEntry = null;

        function addDMEntry(content) {
            const entry = document.createElement('div');
            entry.className = 'narrative-entry entry-dm';
            entry.innerHTML = `
                <div class="entry-header">&#x1F3AD; Dungeon Master</div>
                <div class="entry-content">${escapeHtml(content)}</div>
            `;
            narrativeLog.insertBefore(entry, typingIndicator);
            scrollToBottom();
        }

        function addPlayerEntry(player, content) {
            const entry = document.createElement('div');
            entry.className = 'narrative-entry entry-player';
            entry.innerHTML = `
                <div class="entry-header">&#x2694; ${escapeHtml(player)}</div>
                <div class="entry-content">${escapeHtml(content)}</div>
            `;
            narrativeLog.insertBefore(entry, typingIndicator);
            scrollToBottom();
        }

        function addSystemEntry(content) {
            const entry = document.createElement('div');
            entry.className = 'narrative-entry entry-system';
            entry.textContent = content;
            narrativeLog.insertBefore(entry, typingIndicator);
            scrollToBottom();
        }

        function addDiceEntry(player, notation, result, rolls) {
            const entry = document.createElement('div');
            entry.className = 'narrative-entry';
            entry.innerHTML = `
                <div class="entry-dice">
                    &#x1F3B2; ${escapeHtml(player)} rolled ${notation}:
                    <span class="dice-result">${result}</span>
                    <span style="color: var(--text-muted);">[${rolls.join(', ')}]</span>
                </div>
            `;
            narrativeLog.insertBefore(entry, typingIndicator);
            scrollToBottom();
        }

        function updateStreamingEntry(token) {
            if (!streamingEntry) {
                streamingEntry = document.createElement('div');
                streamingEntry.className = 'narrative-entry entry-dm';
                streamingEntry.innerHTML = `
                    <div class="entry-header">&#x1F3AD; Dungeon Master</div>
                    <div class="entry-content"></div>
                `;
                narrativeLog.insertBefore(streamingEntry, typingIndicator);
            }
            const content = streamingEntry.querySelector('.entry-content');
            content.textContent += token;
            scrollToBottom();
        }

        function finalizeStreamingEntry(fullContent) {
            if (streamingEntry) {
                const content = streamingEntry.querySelector('.entry-content');
                content.textContent = fullContent;
                streamingEntry = null;
            } else {
                addDMEntry(fullContent);
            }
            scrollToBottom();
        }

        function scrollToBottom() {
            narrativeLog.scrollTop = narrativeLog.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updatePlayersList(players) {
            const list = document.getElementById('players-list');
            if (players.length === 0) {
                list.innerHTML = '<div class="player-item"><span style="color: var(--text-muted); font-size: 0.875rem;">No players connected</span></div>';
            } else {
                list.innerHTML = players.map(name => `
                    <div class="player-item">
                        <div class="player-avatar">${name.charAt(0).toUpperCase()}</div>
                        <span class="player-name">${escapeHtml(name)}</span>
                    </div>
                `).join('');
            }
        }

        // Send action
        function sendAction() {
            const action = actionInput.value.trim();
            if (!action) return;

            if (!state.connected) {
                addSystemEntry('Not connected - trying to reconnect...');
                connect();
                // Retry after a short delay
                setTimeout(() => {
                    if (state.connected && actionInput.value.trim()) {
                        sendAction();
                    }
                }, 1000);
                return;
            }

            addPlayerEntry(state.playerName, action);
            state.ws.send(JSON.stringify({
                type: 'player_action',
                action: action,
            }));

            actionInput.value = '';
            actionInput.style.height = 'auto';
        }

        // Roll dice
        function rollDice(notation) {
            if (!state.connected) return;
            state.ws.send(JSON.stringify({
                type: 'dice_roll',
                notation: notation,
            }));
            dicePanel.classList.remove('visible');
        }

        // Voice recording with VAD (Voice Activity Detection)
        async function toggleVoiceRecording() {
            const voiceBtn = document.getElementById('voice-btn');

            if (state.listening || state.recording) {
                // Stop recording
                stopVoiceRecording(false); // Cancel without submitting
                return;
            }

            try {
                // Request microphone
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.audioStream = stream;

                // Set up audio analysis for VAD
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                state.analyser = state.audioContext.createAnalyser();
                state.analyser.fftSize = 256;

                const source = state.audioContext.createMediaStreamSource(stream);
                source.connect(state.analyser);

                // Set up MediaRecorder
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];

                state.mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        state.audioChunks.push(e.data);
                    }
                };

                state.mediaRecorder.onstop = async () => {
                    if (state.speechDetected && state.audioChunks.length > 0) {
                        const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                        await transcribeAudio(audioBlob);
                    }
                    cleanupVoice();
                };

                // Start recording and listening
                state.mediaRecorder.start(100); // Collect data every 100ms
                state.listening = true;
                state.recording = false;
                state.speechDetected = false;

                voiceBtn.classList.add('listening');
                voiceBtn.title = 'Listening... Tap to cancel';

                // Start monitoring audio levels
                monitorAudioLevels();

            } catch (e) {
                console.error('Recording error:', e);
                addSystemEntry('Microphone access denied');
                cleanupVoice();
            }
        }

        function monitorAudioLevels() {
            if (!state.analyser || (!state.listening && !state.recording)) {
                return;
            }

            const dataArray = new Uint8Array(state.analyser.frequencyBinCount);
            state.analyser.getByteFrequencyData(dataArray);

            // Calculate average audio level
            const average = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;

            const voiceBtn = document.getElementById('voice-btn');

            if (average > VAD_CONFIG.silenceThreshold) {
                // Speech detected
                if (!state.speechDetected) {
                    state.speechDetected = true;
                    state.recording = true;
                    state.speechStartTime = Date.now();
                    voiceBtn.classList.remove('listening');
                    voiceBtn.classList.add('recording');
                }

                // Clear silence timer
                if (state.silenceTimer) {
                    clearTimeout(state.silenceTimer);
                    state.silenceTimer = null;
                }
            } else if (state.speechDetected) {
                // Silence after speech - start timer
                if (!state.silenceTimer) {
                    state.silenceTimer = setTimeout(() => {
                        // Check if we had enough speech
                        const speechDuration = Date.now() - state.speechStartTime;
                        if (speechDuration >= VAD_CONFIG.minSpeechDuration) {
                            stopVoiceRecording(true); // Auto-submit
                        } else {
                            // Too short, keep listening
                            state.speechDetected = false;
                            state.recording = false;
                            voiceBtn.classList.remove('recording');
                            voiceBtn.classList.add('listening');
                            state.audioChunks = [];
                        }
                    }, VAD_CONFIG.silenceDuration);
                }
            }

            // Continue monitoring
            if (state.listening || state.recording) {
                requestAnimationFrame(monitorAudioLevels);
            }
        }

        function stopVoiceRecording(submit) {
            const voiceBtn = document.getElementById('voice-btn');

            if (state.silenceTimer) {
                clearTimeout(state.silenceTimer);
                state.silenceTimer = null;
            }

            if (!submit) {
                state.speechDetected = false;
                state.audioChunks = [];
            }

            if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
                state.mediaRecorder.stop();
            } else {
                cleanupVoice();
            }

            voiceBtn.classList.remove('recording', 'listening');
            voiceBtn.title = 'Tap to speak';
        }

        function cleanupVoice() {
            state.listening = false;
            state.recording = false;

            if (state.audioStream) {
                state.audioStream.getTracks().forEach(track => track.stop());
                state.audioStream = null;
            }

            if (state.audioContext) {
                state.audioContext.close().catch(() => {});
                state.audioContext = null;
                state.analyser = null;
            }
        }

        async function transcribeAudio(audioBlob) {
            addSystemEntry('Transcribing...');
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'voice.webm');

                const res = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData,
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.text && data.text.trim()) {
                        actionInput.value = data.text.trim();
                        sendAction();
                    } else {
                        addSystemEntry('No speech detected');
                    }
                } else if (res.status === 503) {
                    addSystemEntry('Voice not available');
                } else {
                    addSystemEntry('Transcription failed');
                }
            } catch (e) {
                console.error('Transcription error:', e);
                addSystemEntry('Transcription error');
            }
        }

        // Start game with session
        function startGame() {
            titleScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
            document.getElementById('header-session-code').textContent = state.sessionCode;
            connect();
        }

        // Load characters for selection
        async function loadCharactersForSelect(containerId) {
            const container = document.getElementById(containerId);
            try {
                const res = await fetch('/api/characters');
                const data = await res.json();

                if (data.characters.length === 0) {
                    container.innerHTML = `
                        <div class="char-select-empty">
                            No characters yet.<br>
                            <a onclick="goToCharacterScreen()">Create one first</a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.characters.map(char => `
                    <div class="char-select-item" data-id="${char.id}" data-name="${escapeHtml(char.name)}">
                        <div class="char-select-avatar">&#x1F9D9;</div>
                        <div class="char-select-info">
                            <div class="char-select-name">${escapeHtml(char.name)}</div>
                            <div class="char-select-meta">${char.race} ${char.character_class} Lv${char.level}</div>
                        </div>
                    </div>
                `).join('');

                container.querySelectorAll('.char-select-item').forEach(item => {
                    item.addEventListener('click', () => {
                        container.querySelectorAll('.char-select-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        state.selectedCharacter = {
                            id: item.dataset.id,
                            name: item.dataset.name
                        };
                    });
                });

                // Auto-select first character
                const first = container.querySelector('.char-select-item');
                if (first) {
                    first.click();
                }
            } catch (e) {
                console.error('Failed to load characters:', e);
                container.innerHTML = '<div class="char-loading">Failed to load characters</div>';
            }
        }

        function goToCharacterScreen() {
            newGameModal.classList.remove('visible');
            joinGameModal.classList.remove('visible');
            titleScreen.style.display = 'none';
            document.getElementById('character-screen').style.display = 'block';
            loadCharacters();
            loadRacesAndClasses();
        }

        // Create new session
        async function createNewSession() {
            try {
                const res = await fetch('/api/sessions', { method: 'POST' });
                const data = await res.json();
                state.sessionCode = data.code;
                state.selectedCharacter = null;
                document.getElementById('new-session-code').textContent = data.code;
                newGameModal.classList.add('visible');
                loadCharactersForSelect('new-game-char-list');
            } catch (e) {
                console.error('Failed to create session:', e);
                alert('Failed to create session');
            }
        }

        // Event Listeners - New Game
        document.getElementById('btn-new-game').addEventListener('click', createNewSession);

        document.getElementById('btn-start-new').addEventListener('click', () => {
            if (!state.selectedCharacter) {
                alert('Please select a character');
                return;
            }
            state.playerName = state.selectedCharacter.name;
            newGameModal.classList.remove('visible');
            startGame();
        });

        document.getElementById('btn-cancel-new').addEventListener('click', () => {
            newGameModal.classList.remove('visible');
        });

        document.getElementById('btn-copy-code').addEventListener('click', async () => {
            const code = state.sessionCode;
            const btn = document.getElementById('btn-copy-code');
            try {
                await navigator.clipboard.writeText(code);
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Code';
                    btn.classList.remove('copied');
                }, 2000);
            } catch (e) {
                // Fallback for older browsers
                const input = document.createElement('input');
                input.value = code;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Code';
                    btn.classList.remove('copied');
                }, 2000);
            }
        });

        // Event Listeners - Join Game
        document.getElementById('btn-join-game').addEventListener('click', () => {
            state.selectedCharacter = null;
            joinGameModal.classList.add('visible');
            loadCharactersForSelect('join-game-char-list');
            document.getElementById('join-code').focus();
        });

        document.getElementById('btn-join-session').addEventListener('click', async () => {
            const code = document.getElementById('join-code').value.trim().toUpperCase();

            if (!code || code.length !== 4) {
                document.getElementById('join-code').focus();
                return;
            }
            if (!state.selectedCharacter) {
                alert('Please select a character');
                return;
            }

            // Verify session exists
            try {
                const res = await fetch(`/api/sessions/${code}`);
                if (!res.ok) {
                    alert('Session not found. Check the code and try again.');
                    return;
                }
            } catch (e) {
                alert('Failed to verify session');
                return;
            }

            state.sessionCode = code;
            state.playerName = state.selectedCharacter.name;
            joinGameModal.classList.remove('visible');
            startGame();
        });

        document.getElementById('btn-cancel-join').addEventListener('click', () => {
            joinGameModal.classList.remove('visible');
        });

        document.getElementById('join-code').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        document.getElementById('join-code').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('btn-join-session').click();
        });

        document.getElementById('send-btn').addEventListener('click', sendAction);
        actionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAction();
            }
        });

        actionInput.addEventListener('input', () => {
            actionInput.style.height = 'auto';
            actionInput.style.height = Math.min(actionInput.scrollHeight, 120) + 'px';
        });

        // Voice button - tap to toggle recording with VAD
        const voiceBtn = document.getElementById('voice-btn');
        voiceBtn.addEventListener('click', toggleVoiceRecording);
        voiceBtn.title = 'Tap to speak';

        // Dice toggle
        document.getElementById('btn-dice-toggle').addEventListener('click', () => {
            dicePanel.classList.toggle('visible');
        });

        // Dice buttons
        document.querySelectorAll('.dice-btn').forEach(btn => {
            btn.addEventListener('click', () => rollDice(btn.dataset.dice));
        });

        // Quick actions and chips
        document.querySelectorAll('.action-btn, .quick-chip[data-action]').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.dataset.action && state.connected) {
                    actionInput.value = btn.dataset.action;
                    sendAction();
                    sidebar.classList.remove('visible');
                    sidebarOverlay.classList.remove('visible');
                }
            });
        });

        // Mobile sidebar toggle
        document.getElementById('btn-menu').addEventListener('click', () => {
            sidebar.classList.add('visible');
            sidebarOverlay.classList.add('visible');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('visible');
            sidebarOverlay.classList.remove('visible');
        });

        // ===== CHARACTER CREATION =====
        const characterScreen = document.getElementById('character-screen');
        const createCharModal = document.getElementById('create-char-modal');
        const characterList = document.getElementById('character-list');

        // Character creation state
        const charState = {
            races: [],
            classes: [],
            selectedRace: null,
            selectedClass: null,
            abilities: {
                strength: 10,
                dexterity: 10,
                constitution: 10,
                intelligence: 10,
                wisdom: 10,
                charisma: 10
            },
            pointsUsed: 0,
            maxPoints: 20
        };

        // Point buy cost table (Pathfinder)
        const pointCost = {
            7: -4, 8: -2, 9: -1, 10: 0, 11: 1, 12: 2, 13: 3, 14: 5, 15: 7, 16: 10, 17: 13, 18: 17
        };

        function calculatePointsUsed() {
            let total = 0;
            for (const ability of Object.values(charState.abilities)) {
                total += pointCost[ability] || 0;
            }
            return total;
        }

        function updatePointsDisplay() {
            charState.pointsUsed = calculatePointsUsed();
            const remaining = charState.maxPoints - charState.pointsUsed;
            document.getElementById('points-remaining').textContent = remaining;
            document.getElementById('points-remaining').style.color = remaining < 0 ? 'var(--danger)' : 'var(--text-primary)';
        }

        function updateAbilityDisplay(ability) {
            const abbrev = ability.substring(0, 3);
            const value = charState.abilities[ability];
            const mod = Math.floor((value - 10) / 2);
            document.getElementById(`${abbrev}-value`).textContent = value;
            document.getElementById(`${abbrev}-mod`).textContent = mod >= 0 ? `+${mod}` : mod;
        }

        function adjustAbility(ability, direction) {
            const current = charState.abilities[ability];
            const newValue = direction === '+' ? current + 1 : current - 1;

            if (newValue < 7 || newValue > 18) return;

            // Check if we have enough points
            charState.abilities[ability] = newValue;
            const newPointsUsed = calculatePointsUsed();

            if (newPointsUsed > charState.maxPoints && direction === '+') {
                charState.abilities[ability] = current;
                return;
            }

            updateAbilityDisplay(ability);
            updatePointsDisplay();
        }

        // Load races and classes
        async function loadRacesAndClasses() {
            try {
                const [racesRes, classesRes] = await Promise.all([
                    fetch('/api/races'),
                    fetch('/api/classes')
                ]);
                const racesData = await racesRes.json();
                const classesData = await classesRes.json();

                charState.races = racesData.races;
                charState.classes = classesData.classes;

                renderRaceOptions();
                renderClassOptions();
            } catch (e) {
                console.error('Failed to load races/classes:', e);
            }
        }

        function renderRaceOptions() {
            const container = document.getElementById('race-options');
            container.innerHTML = charState.races.map(race => `
                <button class="option-btn" data-race="${race.name}">${race.name}</button>
            `).join('');

            container.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    container.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    charState.selectedRace = charState.races.find(r => r.name === btn.dataset.race);
                    document.getElementById('race-info').textContent = charState.selectedRace?.description || '';
                });
            });
        }

        function renderClassOptions() {
            const container = document.getElementById('class-options');
            container.innerHTML = charState.classes.map(cls => `
                <button class="option-btn" data-class="${cls.name}">${cls.name}</button>
            `).join('');

            container.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    container.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    charState.selectedClass = charState.classes.find(c => c.name === btn.dataset.class);
                    const cls = charState.selectedClass;
                    document.getElementById('class-info').textContent = cls ? `${cls.description} (d${cls.hit_die} HP)` : '';
                });
            });
        }

        async function loadCharacters() {
            try {
                const res = await fetch('/api/characters');
                const data = await res.json();
                renderCharacterList(data.characters);
            } catch (e) {
                console.error('Failed to load characters:', e);
                characterList.innerHTML = '<div class="char-loading">Failed to load characters</div>';
            }
        }

        function renderCharacterList(characters) {
            if (characters.length === 0) {
                characterList.innerHTML = `
                    <div class="empty-chars">
                        <p>No characters yet</p>
                        <p style="font-size: 0.875rem;">Create your first character to begin adventuring!</p>
                    </div>
                `;
                return;
            }

            characterList.innerHTML = characters.map(char => `
                <div class="char-card" data-id="${char.id}">
                    <div class="char-avatar">&#x1F9D9;</div>
                    <div class="char-details">
                        <div class="char-name">${escapeHtml(char.name)}</div>
                        <div class="char-meta">${char.race} ${char.character_class} Lv${char.level}</div>
                        <div class="char-hp">HP: ${char.current_hp}/${char.max_hp}</div>
                    </div>
                    <button class="char-delete" data-id="${char.id}">Delete</button>
                </div>
            `).join('');

            characterList.querySelectorAll('.char-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (confirm('Delete this character?')) {
                        await deleteCharacter(btn.dataset.id);
                    }
                });
            });
        }

        async function deleteCharacter(id) {
            try {
                await fetch(`/api/characters/${id}`, { method: 'DELETE' });
                loadCharacters();
            } catch (e) {
                console.error('Failed to delete character:', e);
            }
        }

        function resetCharacterForm() {
            document.getElementById('char-name').value = '';
            charState.selectedRace = null;
            charState.selectedClass = null;
            charState.abilities = { strength: 10, dexterity: 10, constitution: 10, intelligence: 10, wisdom: 10, charisma: 10 };

            document.querySelectorAll('#race-options .option-btn, #class-options .option-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('race-info').textContent = '';
            document.getElementById('class-info').textContent = '';

            ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'].forEach(updateAbilityDisplay);
            updatePointsDisplay();
        }

        async function saveCharacter() {
            const name = document.getElementById('char-name').value.trim();
            if (!name) {
                alert('Please enter a character name');
                return;
            }
            if (!charState.selectedRace) {
                alert('Please select a race');
                return;
            }
            if (!charState.selectedClass) {
                alert('Please select a class');
                return;
            }
            if (charState.pointsUsed > charState.maxPoints) {
                alert('You have used too many points');
                return;
            }

            try {
                const res = await fetch('/api/characters', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        race: charState.selectedRace.name,
                        character_class: charState.selectedClass.name,
                        ...charState.abilities
                    })
                });

                if (res.ok) {
                    createCharModal.classList.remove('visible');
                    loadCharacters();
                } else {
                    const error = await res.json();
                    alert(error.detail || 'Failed to create character');
                }
            } catch (e) {
                console.error('Failed to save character:', e);
                alert('Failed to create character');
            }
        }

        // Character screen event listeners
        document.getElementById('btn-characters').addEventListener('click', () => {
            titleScreen.style.display = 'none';
            characterScreen.style.display = 'block';
            loadCharacters();
            loadRacesAndClasses();
        });

        document.getElementById('btn-back-to-menu').addEventListener('click', () => {
            characterScreen.style.display = 'none';
            titleScreen.style.display = 'flex';
        });

        document.getElementById('btn-create-new').addEventListener('click', () => {
            resetCharacterForm();
            createCharModal.classList.add('visible');
        });

        document.getElementById('btn-cancel-create').addEventListener('click', () => {
            createCharModal.classList.remove('visible');
        });

        document.getElementById('btn-save-char').addEventListener('click', saveCharacter);

        // Ability score buttons
        document.querySelectorAll('.ability-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                adjustAbility(btn.dataset.ability, btn.dataset.dir);
            });
        });

        // Initialize
        checkStatus();
        setInterval(checkStatus, 30000);
    </script>
</body>
</html>
